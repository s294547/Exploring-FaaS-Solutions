---
# Source: edge-chart/charts/openwhisk/templates/network-policy.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

# Default deny all ingress
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: openwhisk-default-no-ingress-np
  labels:
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
spec:
  podSelector: {}
  policyTypes:
  - Ingress
---
# Source: edge-chart/charts/openwhisk/templates/network-policy.yaml
# Backend control plane pods only accept connections from non-user-action-pods
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: openwhisk-backend-np
  labels:
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
spec:
  podSelector:
    matchExpressions:
      - {key: user-action-pod, operator: DoesNotExist}
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchExpressions:
          - {key: user-action-pod, operator: DoesNotExist}
---
# Source: edge-chart/charts/openwhisk/templates/network-policy.yaml
# Frontend pods (nginx, controller, apigateway) accept connections from anyone
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: openwhisk-frontend-np
  labels:
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
spec:
  podSelector:
    matchExpressions:
      - {key: name, operator: In, values: ["openwhisk-controller", "openwhisk-apigateway", "openwhisk-nginx", "mosquitto", "mqtt-provider", "grafana", "grafana-operator", "influxdb", "couchdb"]}
  policyTypes:
  - Ingress
  ingress:
  - {}
---
# Source: edge-chart/charts/openwhisk/templates/network-policy.yaml
# User action pods will only accept connections from invokers
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: openwhisk-actions-allow-invoker-np
  labels:
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
spec:
  podSelector:
    matchExpressions:
      - {key: user-action-pod, operator: In, values: ["true"]}
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          name: openwhisk-invoker
---
# Source: edge-chart/charts/influxdb2/templates/pdb.yaml
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: openwhisk-influxdb2
  labels:
    app.kubernetes.io/name: influxdb2
    app.kubernetes.io/instance: openwhisk
    app.kubernetes.io/version: "2.3.0"
    app.kubernetes.io/managed-by: Helm
    helm.sh/chart: influxdb2-2.1.1
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: influxdb2
      app.kubernetes.io/instance: openwhisk
---
# Source: edge-chart/charts/influxdb2/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: openwhisk-influxdb2
  labels:
    app.kubernetes.io/name: influxdb2
    app.kubernetes.io/instance: openwhisk
    app.kubernetes.io/version: "2.3.0"
    app.kubernetes.io/managed-by: Helm
    helm.sh/chart: influxdb2-2.1.1
---
# Source: edge-chart/charts/mosquitto/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: openwhisk-mosquitto
  labels:
    helm.sh/chart: mosquitto-0.1.0
    app.kubernetes.io/name: mosquitto
    app.kubernetes.io/instance: openwhisk
    app.kubernetes.io/version: "2.0.15"
    app.kubernetes.io/managed-by: Helm
---
# Source: edge-chart/charts/openwhisk/templates/core-svcacct.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

# Core pods are allowed to have view access to k8s APIs
apiVersion: v1
kind: ServiceAccount
metadata:
  name: openwhisk-core
  labels:
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
---
# Source: edge-chart/charts/openwhisk/templates/init-svcact.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

apiVersion: v1
kind: ServiceAccount
metadata:
  name: openwhisk-init-sa
  labels:
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
---
# Source: edge-chart/charts/openwhisk/templates/invoker-svcacct.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: openwhisk-invoker
  labels:
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
---
# Source: edge-chart/charts/openwhisk/templates/prometheus-svcacct.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#


apiVersion: v1
kind: ServiceAccount
metadata:
  name: openwhisk-prometheus-server
---
# Source: edge-chart/charts/influxdb2/templates/secret.yaml
apiVersion: v1
kind: Secret
metadata:
  labels:
    app.kubernetes.io/name: influxdb2
    app.kubernetes.io/instance: openwhisk
    app.kubernetes.io/version: "2.3.0"
    app.kubernetes.io/managed-by: Helm
    helm.sh/chart: influxdb2-2.1.1
  name: openwhisk-influxdb2-auth
data:
  admin-token: "WndXTTJHeDE3YU1uSnJCU0l2YmVjMVdLMFhnYTFvQ0o="
  admin-password: "YWRtaW5vcGVud2hpc2tpbmZsdXhkYg=="
---
# Source: edge-chart/charts/mosquitto/templates/secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: openwhisk-mosquitto
  labels:
    helm.sh/chart: mosquitto-0.1.0
    app.kubernetes.io/name: mosquitto
    app.kubernetes.io/instance: openwhisk
    app.kubernetes.io/version: "2.0.15"
    app.kubernetes.io/managed-by: Helm
stringData:
  passwords.conf: |-
    test:
---
# Source: edge-chart/charts/openwhisk/templates/ow-db-secret.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

apiVersion: v1
kind: Secret
metadata:
  name: openwhisk-db.auth
  labels:
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
type: Opaque
data:
  db_username: YWRtaW4=
  db_password: YWRtaW4=
---
# Source: edge-chart/charts/openwhisk/templates/ow-whisk-secret.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

apiVersion: v1
kind: Secret
metadata:
  name: openwhisk-whisk.auth
  labels:
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
type: Opaque
data:
  system: Nzg5YzQ2YjEtNzFmNi00ZWQ1LThjNTQtODE2YWE0ZjhjNTAyOmFiY3pPM3haQ0xyTU42djJCS0sxZFhZRnBYbFBrY2NPRnFtMTJDZEFzTWdSVTRWck5aOWx5R1ZDR3VNREdJd1A=
  guest: MjNiYzQ2YjEtNzFmNi00ZWQ1LThjNTQtODE2YWE0ZjhjNTAyOjEyM3pPM3haQ0xyTU42djJCS0sxZFhZRnBYbFBrY2NPRnFtMTJDZEFzTWdSVTRWck5aOWx5R1ZDR3VNREdJd1A=
---
# Source: edge-chart/charts/mosquitto/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: openwhisk-mosquitto
  labels:
    helm.sh/chart: mosquitto-0.1.0
    app.kubernetes.io/name: mosquitto
    app.kubernetes.io/instance: openwhisk
    app.kubernetes.io/version: "2.0.15"
    app.kubernetes.io/managed-by: Helm
data:
  mosquitto.conf: |-
    listener 1883 0.0.0.0
    protocol mqtt
    listener 9001 0.0.0.0
    protocol websockets

    log_dest stdout
    max_inflight_messages 20
    max_queued_messages 1000
    allow_anonymous false
    password_file /mosquitto/config/passwords.conf
    acl_file /mosquitto/config/acl.conf
  acl.conf: |-
    user test
    pattern readwrite #
---
# Source: edge-chart/charts/mqtt-provider/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: mqtt-provider-configmap
  labels:
    name: mqtt-provider
    user-action-pod: "true"
  namespace: openwhisk-second
data:
  couchdbUsername: "admin"
  couchdbPassword: "admin"
  couchdbGateway: "couchdb-gateway.liquidfaas.cloud"
  couchdbExtPort: "443"
  apiHost: "38.242.158.232"
---
# Source: edge-chart/charts/openwhisk/templates/gen-certs-cm.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
apiVersion: v1
kind: ConfigMap
metadata:
  name: openwhisk-gen-certs
  labels:
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
data:
  gencerts.sh: |+
    #
    # Licensed to the Apache Software Foundation (ASF) under one or more
    # contributor license agreements.  See the NOTICE file distributed with
    # this work for additional information regarding copyright ownership.
    # The ASF licenses this file to You under the Apache License, Version 2.0
    # (the "License"); you may not use this file except in compliance with
    # the License.  You may obtain a copy of the License at
    #
    #     http://www.apache.org/licenses/LICENSE-2.0
    #
    # Unless required by applicable law or agreed to in writing, software
    # distributed under the License is distributed on an "AS IS" BASIS,
    # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    # See the License for the specific language governing permissions and
    # limitations under the License.
    #
  
    if kubectl get secret $NGINX_CERT_SECRET; then
        echo "using existing $NGINX_CERT_SECRET secret"
    else
        echo "generating new $NGINX_CERT_SECRET secret"
        genssl.sh "*.$WHISK_API_HOST_NAME" server /cert-gen
        kubectl create secret tls $NGINX_CERT_SECRET --cert=/cert-gen/openwhisk-server-cert.pem --key=/cert-gen/openwhisk-server-key.pem
    fi
---
# Source: edge-chart/charts/openwhisk/templates/grafana-cm-dashboard.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#


apiVersion: v1
kind: ConfigMap
metadata:
  name: openwhisk-grafana-dsb-cfg
  labels:
    name: openwhisk-grafana-dsb-cfg
data:
  dashboard.yml: |
    apiVersion: 1
    providers:
    - name: 'Prometheus'
      orgId: 1
      folder: ''
      type: file
      disableDeletion: false
      editable: true
      options:
        path: /var/lib/grafana/dashboards
---
# Source: edge-chart/charts/openwhisk/templates/grafana-cm-datasource.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#


apiVersion: v1
kind: ConfigMap
metadata:
  name: openwhisk-grafana-ds-cfg
  labels:
    name: openwhisk-grafana-ds-cfg
data:
  datasource.yml: |
    datasources:
    - name: Prometheus
      type: prometheus
      access: proxy
      isDefault: true
      url: http://openwhisk-prometheus-server.openwhisk-second.svc.cluster.local:9090
---
# Source: edge-chart/charts/openwhisk/templates/grafana-cm-download.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#


apiVersion: v1
kind: ConfigMap
metadata:
  name: openwhisk-grafana-download
  labels:
    name: openwhisk-grafana-download
data:
  download_dashboards.sh: |
    #!/usr/bin/env sh
      curl -sk \
      --connect-timeout 60 \
      --max-time 60 \
      -H "Accept: application/json" \
      -H "Content-Type: application/json;charset=UTF-8" \
      https://raw.githubusercontent.com/apache/openwhisk/master/core/monitoring/user-events/compose/grafana/dashboards/openwhisk_events.json  > /var/lib/grafana/dashboards/0.json
      curl -sk \
      --connect-timeout 60 \
      --max-time 60 \
      -H "Accept: application/json" \
      -H "Content-Type: application/json;charset=UTF-8" \
      https://raw.githubusercontent.com/apache/openwhisk/master/core/monitoring/user-events/compose/grafana/dashboards/global-metrics.json  > /var/lib/grafana/dashboards/1.json
      curl -sk \
      --connect-timeout 60 \
      --max-time 60 \
      -H "Accept: application/json" \
      -H "Content-Type: application/json;charset=UTF-8" \
      https://raw.githubusercontent.com/apache/openwhisk/master/core/monitoring/user-events/compose/grafana/dashboards/top-namespaces.json  > /var/lib/grafana/dashboards/2.json
---
# Source: edge-chart/charts/openwhisk/templates/install-packages-cm.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

apiVersion: v1
kind: ConfigMap
metadata:
  name: openwhisk-install-packages-cm
  labels:
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
data:
  myTask.sh: |+
    #
    # Licensed to the Apache Software Foundation (ASF) under one or more
    # contributor license agreements.  See the NOTICE file distributed with
    # this work for additional information regarding copyright ownership.
    # The ASF licenses this file to You under the Apache License, Version 2.0
    # (the "License"); you may not use this file except in compliance with
    # the License.  You may obtain a copy of the License at
    #
    #     http://www.apache.org/licenses/LICENSE-2.0
    #
    # Unless required by applicable law or agreed to in writing, software
    # distributed under the License is distributed on an "AS IS" BASIS,
    # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    # See the License for the specific language governing permissions and
    # limitations under the License.
    #
  
    export OPENWHISK_HOME=/openwhisk
  
    export PROVIDER_DB_URL=$PROVIDER_DB_PROTOCOL://$PROVIDER_DB_USERNAME:$PROVIDER_DB_PASSWORD@$PROVIDER_DB_HOST:$PROVIDER_DB_PORT
  
    #####
    # Install Route Mgmt Support
    #####
  
    # Clone openwhisk repo to get installRouteMgmt.sh and core/routemgmt
    git clone https://github.com/apache/openwhisk openwhisk
    pushd openwhisk
        git checkout $OW_GIT_TAG_OPENWHISK
        rm -f /openwhisk/ansible/files/auth.guest /openwhisk/ansible/files/auth.whisk.system
    popd
  
    # Setup env for installRouteMgmt.sh
    if [ "$WHISK_API_GATEWAY_USER" ]; then
        export GW_USER=$WHISK_API_GATEWAY_USER
    else
        export GW_USER=' '
    fi
    if [ "$WHISK_API_GATEWAY_PASSWORD" ]; then
        export GW_PWD=$WHISK_API_GATEWAY_PASSWORD
    else
        export GW_PWD=' '
    fi
    if [ "$WHISK_API_GATEWAY_HOST_V2" ]; then
        export GW_HOST_V2=$WHISK_API_GATEWAY_HOST_V2
    else
        echo "Must provide a value for WHISK_API_GATEWAY_HOST_V2"
        exit 1
    fi
  
    pushd $OPENWHISK_HOME/ansible/roles/routemgmt/files
        # This operation is unreliable in a TravisCI environment (for unknown reasons),
        # so try multiple times before giving up.
        PASSED=false
        TRIES=0
        until $PASSED || [ $TRIES -eq 10 ]; do
            if ./installRouteMgmt.sh $WHISK_AUTH $WHISK_API_HOST_URL $WHISK_SYSTEM_NAMESPACE /usr/local/bin/wsk; then
                PASSED=true
                echo "Successfully deployed routemgmt package"
            else
                echo "Failed to deploy routemgmt package; will pause, uninstall, and try again"
                let TRIES=TRIES+1
                sleep 10
                ./uninstallRouteMgmt.sh $WHISK_AUTH $WHISK_API_HOST_URL $WHISK_SYSTEM_NAMESPACE /usr/local/bin/wsk;
            fi
        done
        if ! $PASSED; then
            echo "Giving up after 10 failed attempts to install the routemgmt package"
            exit 1
        fi
    popd
  
    #####
    # Install the OpenWhisk Catalog
    #####
    git clone https://github.com/apache/openwhisk-catalog openwhisk-catalog
    pushd openwhisk-catalog
        git checkout $OW_GIT_TAG_OPENWHISK_CATALOG
    popd
  
    pushd openwhisk-catalog/packages
        ./installCatalogUsingWskdeploy.sh $WHISK_AUTH $WHISK_API_HOST_URL /usr/local/bin/wsk || exit 1
    popd
  
  
    #####
    # Install catalogs for each enabled Event Provider
    #####
  
    # UGH: installCatalog.sh for the providers hardwires that it wants $OPENWHISK_HOME/bin/wsk
    cp /usr/local/bin/wsk $OPENWHISK_HOME/bin/wsk
  
  
    #####
    # Install the catalog for the Alarm provider
    #####
  
    if [ "$OW_INSTALL_ALARM_PROVIDER" == "yes" ]; then
        cd /
        git clone https://github.com/apache/openwhisk-package-alarms.git
  
        pushd /openwhisk-package-alarms
            git checkout $OW_GIT_TAG_OPENWHISK_PACKAGE_ALARMS
            ./installCatalog.sh $WHISK_AUTH $WHISK_API_HOST_URL $WHISK_API_HOST_URL worker0 $PROVIDER_DB_URL $ALARM_DB_PREFIX || exit 1
        popd
    fi
  
  
    #####
    # Install the catalog for the Kafka provider
    #####
  
    if [ "$OW_INSTALL_KAFKA_PROVIDER" == "yes" ]; then
        cd /
        git clone https://github.com/apache/openwhisk-package-kafka.git
  
        pushd /openwhisk-package-kafka
            git checkout $OW_GIT_TAG_OPENWHISK_PACKAGE_KAFKA
            ./installKafka.sh $WHISK_AUTH $WHISK_API_HOST_URL $PROVIDER_DB_URL $KAFKA_DB_PREFIX $WHISK_API_HOST_URL || exit 1
            ./installCatalog.sh $WHISK_AUTH $WHISK_API_HOST_URL $PROVIDER_DB_URL $KAFKA_DB_PREFIX $WHISK_API_HOST_URL || exit 1
        popd
    fi
---
# Source: edge-chart/charts/openwhisk/templates/invoker-cm.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

apiVersion: v1
kind: ConfigMap
metadata:
  name: openwhisk-invoker-scripts
  labels:
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
data:
  playbook.yml: |
    #
    # Licensed to the Apache Software Foundation (ASF) under one or more
    # contributor license agreements.  See the NOTICE file distributed with
    # this work for additional information regarding copyright ownership.
    # The ASF licenses this file to You under the Apache License, Version 2.0
    # (the "License"); you may not use this file except in compliance with
    # the License.  You may obtain a copy of the License at
    #
    #     http://www.apache.org/licenses/LICENSE-2.0
    #
    # Unless required by applicable law or agreed to in writing, software
    # distributed under the License is distributed on an "AS IS" BASIS,
    # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    # See the License for the specific language governing permissions and
    # limitations under the License.
    #
    ---
  
    # Playbook to prefetch runtime action images from a docker registry for an invoker node
    # as specified by the RUNTIMES_MANIFEST environment variable
    # Note: If RUNTIMES_REGISTRY is not "", it must include a trailing '/'
  
    - hosts: localhost
      vars:
        docker_pull_retries: 10
        docker_pull_delay: 10
        runtimes_registry: "{{ lookup('env', 'RUNTIMES_REGISTRY') | default() }}"
        runtimes_registry_username: "{{ lookup('env', 'RUNTIMES_REGISTRY_USERNAME') | default() }}"
        runtimes_registry_password: "{{ lookup('env', 'RUNTIMES_REGISTRY_PASSWORD') | default() }}"
        runtimes_manifest: "{{ lookup('env', 'RUNTIMES_MANIFEST') }}"
        runtimes_manifest_json: "{{ lookup('env', 'RUNTIMES_MANIFEST') | from_json }}"
  
      tasks:
        - name: docker login
          docker_login:
            registry: "{{ runtimes_registry }}"
            username: "{{ runtimes_registry_username }}"
            password: "{{ runtimes_registry_password }}"
          when: runtimes_registry != "" and runtimes_registry_password is defined
  
        - name: "Display runtime manifest"
          debug:
            var: runtimes_manifest
  
        - name: "Process runtime manifest"
          set_fact:
            docker_images_managed: "{{ runtimes_manifest_json.runtimes.values() | sum(start=[]) | selectattr('deprecated', 'equalto', false)  | map(attribute='image') | list | unique }}"
            docker_images_blackbox: "{{ runtimes_manifest_json.blackboxes }}"
  
        - name: "pull runtime action images per manifest"
          shell: "docker pull {{runtimes_registry}}{{item.prefix}}/{{item.name}}:{{item.tag | default()}}"
          with_items:
            - "{{ docker_images_managed }}"
          retries: "{{ docker_pull_retries }}"
          delay: "{{ docker_pull_delay }}"
  
        - name: "pull blackboxes action images per manifest"
          shell: "docker pull {{runtimes_registry}}{{item.prefix}}/{{item.name}}:{{item.tag | default()}}"
          with_items:
            - "{{ docker_images_blackbox }}"
          retries: "{{ docker_pull_retries }}"
          delay: "{{ docker_pull_delay }}"
  configureDNS.sh: |
    #
    # Licensed to the Apache Software Foundation (ASF) under one or more
    # contributor license agreements.  See the NOTICE file distributed with
    # this work for additional information regarding copyright ownership.
    # The ASF licenses this file to You under the Apache License, Version 2.0
    # (the "License"); you may not use this file except in compliance with
    # the License.  You may obtain a copy of the License at
    #
    #     http://www.apache.org/licenses/LICENSE-2.0
    #
    # Unless required by applicable law or agreed to in writing, software
    # distributed under the License is distributed on an "AS IS" BASIS,
    # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    # See the License for the specific language governing permissions and
    # limitations under the License.
    #
  
    exportVars() {
        vname=$1
        vals=$2
  
        let "idx=0"
        for v in $vals; do
            export $(echo $vname$idx)=$v
            let "idx=idx+1"
        done
    }
  
    echo "The contents of /etc/resolv.conf are:"
    cat /etc/resolv.conf
  
    nameservers=$(grep -e ^nameserver /etc/resolv.conf | sed 's/nameserver //')
    search=$(grep -e ^search /etc/resolv.conf | sed 's/search //')
    options=$(grep -e ^option /etc/resolv.conf | sed 's/option //')
  
    exportVars "CONFIG_whisk_containerFactory_containerArgs_dnsServers_" "$nameservers"
    exportVars "CONFIG_whisk_containerFactory_containerArgs_dnsSearch_" "$search"
    exportVars "CONFIG_whisk_containerFactory_containerArgs_dnsOptions_" "$options"
---
# Source: edge-chart/charts/openwhisk/templates/nginx-cm.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

apiVersion: v1
kind: ConfigMap
metadata:
  name: openwhisk-nginx
  labels:
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
data:
  nginx.conf: |
    worker_processes auto;
    worker_rlimit_nofile 4096;

    events {
      worker_connections  4096;
    }

    http {
      client_max_body_size 50M;

      rewrite_log on;
      # change log format to display the upstream information
      log_format combined-upstream '$remote_addr - $remote_user [$time_local] '
          '[#tid_$request_id] $request $status $body_bytes_sent '
          '$http_referer $http_user_agent $upstream_addr';
      access_log /logs/nginx_access.log combined-upstream;
      error_log /logs/nginx_error.log error;

      # needed to enable keepalive to upstream controllers
      proxy_http_version 1.1;
      proxy_set_header Connection "";

      upstream controllers {
         # Mark the controller as unavailable after fail_timeout seconds, to not get any requests during restart.
         # Otherwise, nginx would dispatch requests when the container is up, but the backend in the container not.
         # From the docs:
         #  "normally, requests with a non-idempotent method (POST, LOCK, PATCH) are not passed to
         #   the next server if a request has been sent to an upstream server"
         server openwhisk-controller.openwhisk-second.svc.cluster.local:8080 fail_timeout=60s;

         keepalive 512;
      }

      server {
        listen 80;
        listen 443 default ssl;

        # match namespace, note while OpenWhisk allows a richer character set for a
        # namespace, not all those characters are permitted in the (sub)domain name;
        # if namespace does not match, no vanity URL rewriting takes place.
        server_name ~^(?<namespace>[0-9a-zA-Z-]+)\.38.242.158.232$;
        ssl_session_cache    shared:SSL:1m;
        ssl_session_timeout  10m;
        ssl_certificate      /etc/nginx/certs/tls.crt;
        ssl_certificate_key  /etc/nginx/certs/tls.key;
        ssl_verify_client off;
        ssl_protocols        TLSv1.2;
        ssl_ciphers ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256;
        ssl_prefer_server_ciphers on;
        proxy_ssl_session_reuse on;
        proxy_ssl_verify off;

        # Hack to convince nginx to dynamically resolve the dns entries.
        resolver kube-dns.kube-system;
        set $apigw openwhisk-apigateway.openwhisk-second.svc.cluster.local;

        set $grafana openwhisk-grafana.openwhisk-second.svc.cluster.local;
        location /api/v1/web {
            if ($namespace) {
                rewrite    /(.*) /api/v1/web/${namespace}/$1 break;
            }
            proxy_pass http://controllers;
            proxy_read_timeout 75s; # 70+5 additional seconds to allow controller to terminate request
        }

        location /api/v1 {
            proxy_pass http://controllers;
            proxy_read_timeout 75s; # 70+5 additional seconds to allow controller to terminate request
        }

        location /api {
            proxy_pass http://$apigw:8080;
        }

        location /v1/health-check {
            proxy_pass http://$apigw:9000;
        }

        location /v2 {
            proxy_pass http://$apigw:9000;
        }


        location /monitoring {
            proxy_pass http://$grafana:3000;
        }
        location / {
            if ($namespace) {
              rewrite    /(.*) /api/v1/web/${namespace}/$1 break;
            }
            proxy_pass http://controllers;
            proxy_read_timeout 75s; # 70+5 additional seconds to allow controller to terminate request
        }

        location /blackbox.tar.gz {
            return 301 https://github.com/apache/openwhisk-runtime-docker/releases/download/sdk%400.1.0/blackbox-0.1.0.tar.gz;
        }
        # leaving this for a while for clients out there to update to the new endpoint
        location /blackbox-0.1.0.tar.gz {
            return 301 /blackbox.tar.gz;
        }

        location /OpenWhiskIOSStarterApp.zip {
            return 301 https://github.com/openwhisk/openwhisk-client-swift/releases/download/0.2.3/starterapp-0.2.3.zip;
        }

        # redirect requests for specific binaries to the matching one from the latest openwhisk-cli release.
        location /cli/go/download/linux/amd64 {
            return 301 https://github.com/apache/openwhisk-cli/releases/download/latest/OpenWhisk_CLI-latest-linux-amd64.tgz;
        }
        location /cli/go/download/linux/386 {
            return 301 https://github.com/apache/openwhisk-cli/releases/download/latest/OpenWhisk_CLI-latest-linux-386.tgz;
        }
        location /cli/go/download/mac/amd64 {
            return 301 https://github.com/apache/openwhisk-cli/releases/download/latest/OpenWhisk_CLI-latest-mac-amd64.zip;
        }
        location /cli/go/download/mac/386 {
            return 301 https://github.com/apache/openwhisk-cli/releases/download/latest/OpenWhisk_CLI-latest-mac-386.zip;
        }
        location /cli/go/download/windows/amd64 {
            return 301 https://github.com/apache/openwhisk-cli/releases/download/latest/OpenWhisk_CLI-latest-windows-amd64.zip;
        }
        location /cli/go/download/windows/386 {
            return 301 https://github.com/apache/openwhisk-cli/releases/download/latest/OpenWhisk_CLI-latest-windows-386.zip;
        }

        # redirect top-level cli downloads to the latest openwhisk-cli release.
        location /cli/go/download {
            return 301 https://github.com/apache/openwhisk-cli/releases/latest;
        }
      }
    }
---
# Source: edge-chart/charts/openwhisk/templates/ow-db-cm.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

apiVersion: v1
kind: ConfigMap
metadata:
  name: openwhisk-db.config
  labels:
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
data:
  db_prefix: "test_"
  db_protocol: "https"
  db_provider: "CouchDB"
  db_host: "couchdb-gateway.liquidfaas.cloud"
  db_port: "443"
  db_url: "https://couchdb-gateway.liquidfaas.cloud:443"
  db_host_port: "couchdb-gateway.liquidfaas.cloud:443"
  db_whisk_actions: "test_whisks"
  db_whisk_activations: "test_activations"
  db_whisk_auths: "test_subjects"
---
# Source: edge-chart/charts/openwhisk/templates/ow-whisk-cm.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

apiVersion: v1
kind: ConfigMap
metadata:
  name: openwhisk-whisk.config
  labels:
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
data:
  whisk_info_date: "2022-10-14-13:44:50Z"
  whisk_info_buildNo: "20221014"
  whisk_cli_version_tag: "1.1.0"
  whisk_system_namespace: "/whisk.system"
  whisk_external_api_host_proto: "https"
  whisk_external_api_host_port: "30002"
  whisk_external_api_host_name: "38.242.158.232"
  whisk_external_api_host_nameAndPort: "38.242.158.232:30002"
  whisk_external_api_host_url: "https://38.242.158.232:30002"
  whisk_internal_api_host_proto: "http"
  whisk_internal_api_host_port: "80"
  whisk_internal_api_host_name: "openwhisk-nginx.openwhisk-second.svc.cluster.local"
  whisk_internal_api_host_nameAndPort: "openwhisk-nginx.openwhisk-second.svc.cluster.local:80"
  whisk_internal_api_host_url: "http://openwhisk-nginx.openwhisk-second.svc.cluster.local:80"
---
# Source: edge-chart/charts/openwhisk/templates/prometheus-cm.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#


apiVersion: v1
kind: ConfigMap
metadata:
  name: openwhisk-prometheus-configuration
  labels:
    name: openwhisk-prometheus-configuration
data:
  prometheus.yaml: |
    #
    # Licensed to the Apache Software Foundation (ASF) under one or more
    # contributor license agreements.  See the NOTICE file distributed with
    # this work for additional information regarding copyright ownership.
    # The ASF licenses this file to You under the Apache License, Version 2.0
    # (the "License"); you may not use this file except in compliance with
    # the License.  You may obtain a copy of the License at
    #
    #     http://www.apache.org/licenses/LICENSE-2.0
    #
    # Unless required by applicable law or agreed to in writing, software
    # distributed under the License is distributed on an "AS IS" BASIS,
    # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    # See the License for the specific language governing permissions and
    # limitations under the License.
    #
  
    # See https://github.com/prometheus/prometheus/blob/master/documentation/examples/prometheus-kubernetes.yml
    # For details on various options
    global:
      scrape_interval: 10s
    scrape_configs:
  
      - job_name: 'kubernetes-pods'
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
            action: keep
            regex: true
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
            action: replace
            target_label: __metrics_path__
            regex: (.+)
          - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
            action: replace
            regex: ([^:]+)(?::\d+)?;(\d+)
            replacement: $1:$2
            target_label: __address__
          - action: labelmap
            regex: __meta_kubernetes_pod_label_(.+)
          - source_labels: [__meta_kubernetes_namespace]
            action: replace
            target_label: kubernetes_namespace
          - source_labels: [__meta_kubernetes_pod_name]
            action: replace
            target_label: kubernetes_pod_name
---
# Source: edge-chart/charts/openwhisk/templates/tests/package-checker-cm.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
apiVersion: v1
kind: ConfigMap
metadata:
  name: openwhisk-tests-package-checker
  labels:
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
data:
  myTask.sh: |+
    #
    # Licensed to the Apache Software Foundation (ASF) under one or more
    # contributor license agreements.  See the NOTICE file distributed with
    # this work for additional information regarding copyright ownership.
    # The ASF licenses this file to You under the Apache License, Version 2.0
    # (the "License"); you may not use this file except in compliance with
    # the License.  You may obtain a copy of the License at
    #
    #     http://www.apache.org/licenses/LICENSE-2.0
    #
    # Unless required by applicable law or agreed to in writing, software
    # distributed under the License is distributed on an "AS IS" BASIS,
    # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    # See the License for the specific language governing permissions and
    # limitations under the License.
    #
  
    # This test verifies that the catalog of system packages has been properly
    # installed and is accessible using the guest auth.
  
    packageListingCheck() {
      echo "Looking for package $1"
      if [ -z "$1" ]; then
        echo "Error, package listing check called without a package name"
        exit 1
      fi
  
      # Try several times to accommodate eventual consistency of CouchDB
      PACKAGE_LIST_PASSED=false
      PACKAGE_LIST_ATTEMPTS=0
      until $PACKAGE_LIST_PASSED; do
          RESULT=$(wsk package list /whisk.system -i | grep "$1")
          if [ -z "$RESULT" ]; then
              let PACKAGE_LIST_ATTEMPTS=PACKAGE_LIST_ATTEMPTS+1
              if [ $PACKAGE_LIST_ATTEMPTS -gt 5 ]; then
                  echo "FAILED! Could not list package $1"
                  exit 1
              fi
              echo "wsk package list did not find $1; sleep 5 seconds and try again"
              sleep 5
          else
              echo "success: wsk package list included $1"
              PACKAGE_LIST_PASSED=true
          fi
      done
    }
  
    # Configure wsk CLI
    wsk property set --auth $WSK_AUTH --apihost $WSK_API_HOST_URL
  
  
    # Check for the standard catalog of packages
    packageListingCheck "github"
    packageListingCheck "slack"
    packageListingCheck "utils"
    packageListingCheck "samples"
    packageListingCheck "websocket"
  
    # Check packages for installed event providers
    if [ "$OW_INSTALL_ALARM_PROVIDER" == "yes" ]; then
        packageListingCheck "alarms"
    fi
    if [ "$OW_INSTALL_KAFKA_PROVIDER" == "yes" ]; then
        packageListingCheck "messaging"
    fi
  
    # Invoke /whisk.system/utils.echo as a smoketest of the installed actions
    RESULT=$(wsk -i action invoke --blocking /whisk.system/utils/echo -p msg HelloWhisker | grep "\"msg\": \"HelloWhisker\"")
    if [ -z "$RESULT" ]; then
        echo "FAILED! Did not get expected result from invoking /whisk.system/utils/echo"
        echo $RESULT
        exit 1
    fi
  
    echo "PASSED! Listed all expected packages and successfully invoked echo action"
---
# Source: edge-chart/charts/openwhisk/templates/tests/smoketest-cm.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
apiVersion: v1
kind: ConfigMap
metadata:
  name: openwhisk-tests-smoketest
  labels:
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
data:
  myTask.sh: |+
    #
    # Licensed to the Apache Software Foundation (ASF) under one or more
    # contributor license agreements.  See the NOTICE file distributed with
    # this work for additional information regarding copyright ownership.
    # The ASF licenses this file to You under the Apache License, Version 2.0
    # (the "License"); you may not use this file except in compliance with
    # the License.  You may obtain a copy of the License at
    #
    #     http://www.apache.org/licenses/LICENSE-2.0
    #
    # Unless required by applicable law or agreed to in writing, software
    # distributed under the License is distributed on an "AS IS" BASIS,
    # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    # See the License for the specific language governing permissions and
    # limitations under the License.
    #
  
    # A short smoketest to verify basic functionality of an OpenWhisk deployment
  
    # Configure wsk CLI
    wsk property set --auth $WSK_AUTH --apihost $WSK_API_HOST_URL
  
    # create wsk action
    cat > /tmp/hello.js << EOL
    function main() {
      return {body: 'Hello world'}
    }
    EOL
  
    echo "Creating action"
    wsk -i action create hello /tmp/hello.js --web true || (echo "FAILED! Could not create a hello action!"; exit 1)
  
    # first list actions and expect to see hello
    # Try several times to accommodate eventual consistency of CouchDB
    echo "Listing action"
    ACTION_LIST_PASSED=false
    ACTION_LIST_ATTEMPTS=0
    until $ACTION_LIST_PASSED; do
      RESULT=$(wsk -i action list | grep hello)
      if [ -z "$RESULT" ]; then
        let ACTION_LIST_ATTEMPTS=ACTION_LIST_ATTEMPTS+1
        if [ $ACTION_LIST_ATTEMPTS -gt 5 ]; then
          echo "FAILED! Could not list hello action via CLI"
          exit 1
        fi
        echo "wsk action list did not include hello; sleep 5 seconds and try again"
        sleep 5
      else
          echo "success: wsk action list included hello"
          ACTION_LIST_PASSED=true
      fi
    done
  
    # next invoke the new hello world action via the CLI
    echo "Invoking action via CLI"
    RESULT=$(wsk -i action invoke --blocking hello | grep "\"status\": \"success\"")
    if [ -z "$RESULT" ]; then
      echo "FAILED! Could not invoke hello action via CLI"
      exit 1
    fi
  
    # now run it as a web action
    echo "Invoking as web action"
    HELLO_URL=$(wsk -i action get hello --url | grep "https://")
    if [ -z "$HELLO_URL" ]; then
        HELLO_URL=$(wsk -i action get hello --url | grep "http://")
    fi
    RESULT=$(wget --no-check-certificate -qO- $HELLO_URL | grep 'Hello world')
    if [ -z "$RESULT" ]; then
      echo "FAILED! Could not invoke hello as a web action"
      exit 1
    fi
  
    # now define it as an api and invoke it that way
    echo "Registering as an api"
    wsk -i api create /demo /hello get hello || (echo "FAILED: unable to create API"; exit 1)
    echo "Invoking action via the api"
    API_URL=$(wsk -i api list | grep hello | awk '{print $4}')
    echo "External api URL: $API_URL"
    INTERNAL_URL=$(echo $API_URL | sed s#^http.*/api/#$WSK_API_HOST_URL/api/#)
    echo "Internal api URL: $INTERNAL_URL"
    RESULT=$(wget --no-check-certificate -qO- "$INTERNAL_URL" | grep 'Hello world')
    if [ -z "$RESULT" ]; then
      echo "FAILED! Could not invoke hello via apigateway"
      exit 1
    fi
  
    # now delete the resources so the test could be run again
    wsk -i api delete /demo || (echo "FAILED! failed to delete API"; exit 1)
    wsk -i action delete hello || (echo "FAILED! failed to delete action"; exit 1)
  
    echo "PASSED! Created Hello action and invoked via cli, web and apigateway"
---
# Source: edge-chart/charts/openwhisk/templates/zookeeper-cm.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: openwhisk-zookeeper
  labels:
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
data:
  zoo.cfg: |
    tickTime=2000
    clientPort=2181
    initLimit=5
    syncLimit=2
    dataDir=/data
    dataLogDir=/datalog
    server.0=openwhisk-zookeeper-0.openwhisk-zookeeper.openwhisk-second.svc.cluster.local:2888:3888
---
# Source: edge-chart/charts/influxdb2/templates/persistent-volume-claim.yaml
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: "openwhisk-influxdb2"
  labels:
    app.kubernetes.io/name: influxdb2
    app.kubernetes.io/instance: openwhisk
    app.kubernetes.io/version: "2.3.0"
    app.kubernetes.io/managed-by: Helm
    helm.sh/chart: influxdb2-2.1.1
  annotations:
    helm.sh/resource-policy: "keep"
spec:
  accessModes:
    - "ReadWriteOnce"
  resources:
    requests:
      storage: "50Gi"
---
# Source: edge-chart/charts/openwhisk/templates/etcd-pvc.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: openwhisk-etcd-pvc
  labels:
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 256Mi
---
# Source: edge-chart/charts/openwhisk/templates/kafka-pvc.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#


apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: openwhisk-kafka-pvc
  labels:
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 512Mi
---
# Source: edge-chart/charts/openwhisk/templates/prometheus-pvc.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#



apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: openwhisk-prometheus-pvc
  labels:
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
---
# Source: edge-chart/charts/openwhisk/templates/provider-alarm-pvc.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: openwhisk-alarmprovider-pvc
  labels:
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
---
# Source: edge-chart/charts/openwhisk/templates/redis-pvc.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: openwhisk-redis-pvc
  labels:
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 256Mi
---
# Source: edge-chart/charts/openwhisk/templates/zookeeper-pvc-data.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#


apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: "openwhisk-zookeeper-pvc-data"
  labels:
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 256Mi
---
# Source: edge-chart/charts/openwhisk/templates/zookeeper-pvc-datalog.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#


apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: "openwhisk-zookeeper-pvc-datalog"
  labels:
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 256Mi
---
# Source: edge-chart/charts/openwhisk/templates/prometheus-role.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#


apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: openwhisk-prometheus-server
rules:
  - apiGroups: [""]
    resources:
      - services
      - endpoints
      - pods
    verbs: ["get", "list", "watch"]
---
# Source: edge-chart/charts/openwhisk/templates/prometheus-rolebind.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#


apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: openwhisk-prometheus-server
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: openwhisk-prometheus-server
subjects:
  - kind: ServiceAccount
    name: openwhisk-prometheus-server
    namespace: openwhisk-second
---
# Source: edge-chart/charts/openwhisk/templates/init-role.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

# A role to allow initialization jobs to create secrets and config maps
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: openwhisk-init-role
  labels:
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
rules:
- apiGroups: [""]
  resources: ["secrets", "configmaps"]
  verbs: ["create", "get"]
---
# Source: edge-chart/charts/openwhisk/templates/invoker-role.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#


# When using KubernetesContainerFactory, invoker pods need extensive
# permissions to manage pods and deployments. The ability to create
# pods can enable privilege escalation attacks, so restrict it to a
# ServiceAccount that is only used for the invokers and only defined
# when using KubernetesContainerFactory.
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: openwhisk-invoker
  labels:
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
rules:
- apiGroups: ["extensions", "apps"]
  resources: ["deployments"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: [""]
  resources: ["events"]
  verbs: ["get", "list"]
- apiGroups: [""]
  resources: ["pods/log"]
  verbs: ["get", "list"]
---
# Source: edge-chart/charts/openwhisk/templates/core-rolebind.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

# Core pods are allowed to have view access to k8s APIs
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: openwhisk-allow-view
  labels:
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: view
subjects:
  - kind: ServiceAccount
    name: openwhisk-core
    namespace: "openwhisk-second"
---
# Source: edge-chart/charts/openwhisk/templates/init-rolebind.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: openwhisk-init-rb
  labels:
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
subjects:
- kind: ServiceAccount
  namespace: "openwhisk-second"
  name: openwhisk-init-sa
roleRef:
  kind: Role
  name: openwhisk-init-role
  apiGroup: rbac.authorization.k8s.io
---
# Source: edge-chart/charts/openwhisk/templates/invoker-rolebind.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#


# When using KubernetesContainerFactory, invoker pods need extensive
# permissions to manage pods and deployments. The ability to create
# pods can enable privilege escalation attacks, so restrict it to a
# ServiceAccount that is only used for the invokers and only defined
# when using KubernetesContainerFactory.
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: openwhisk-invoker
  labels:
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
subjects:
- kind: ServiceAccount
  namespace: "openwhisk-second"
  name:  openwhisk-invoker 
roleRef:
  kind: Role
  name: openwhisk-invoker
  apiGroup: rbac.authorization.k8s.io
---
# Source: edge-chart/charts/influxdb2/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: openwhisk-influxdb2
  labels:
    app.kubernetes.io/name: influxdb2
    app.kubernetes.io/instance: openwhisk
    app.kubernetes.io/version: "2.3.0"
    app.kubernetes.io/managed-by: Helm
    helm.sh/chart: influxdb2-2.1.1
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 80
      protocol: TCP
      targetPort: 8086
  selector:
    app.kubernetes.io/name: influxdb2
    app.kubernetes.io/instance: openwhisk
---
# Source: edge-chart/charts/mosquitto/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: openwhisk-mosquitto
  labels:
    helm.sh/chart: mosquitto-0.1.0
    app.kubernetes.io/name: mosquitto
    app.kubernetes.io/instance: openwhisk
    app.kubernetes.io/version: "2.0.15"
    app.kubernetes.io/managed-by: Helm
spec:
  type: NodePort
  ports:
    - port: 1883
      targetPort: mqtt
      protocol: TCP
      name: mqtt
    - port: 9001
      targetPort: mqtt-ws
      protocol: TCP
      name: mqtt-ws
  selector:
    app.kubernetes.io/name: mosquitto
    app.kubernetes.io/instance: openwhisk
---
# Source: edge-chart/charts/mqtt-provider/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  labels:
    name: mqtt-provider
    user-action-pod: "true"
  name: mqtt-provider
  namespace: openwhisk-second
spec:
  internalTrafficPolicy: Cluster
  ipFamilies:
  - IPv4
  ipFamilyPolicy: SingleStack
  ports:
  - port: 3000
    protocol: TCP
    targetPort: 3000
  selector:
    app: mqtt-service-provider
  sessionAffinity: None
  type: ClusterIP
---
# Source: edge-chart/charts/openwhisk/templates/apigateway-svc.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

apiVersion: v1
kind: Service
metadata:
  name: openwhisk-apigateway
  labels:
    name: openwhisk-apigateway
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
spec:
  selector:
    name: openwhisk-apigateway
  ports:
    - port: 8080
      name: mgmt
    - port: 9000
      name: api
---
# Source: edge-chart/charts/openwhisk/templates/controller-svc.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

apiVersion: v1
kind: Service
metadata:
  name: openwhisk-controller
  labels:
    name: openwhisk-controller
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
spec:
  selector:
    name: openwhisk-controller
  ports:
    - port: 8080
      name: http
---
# Source: edge-chart/charts/openwhisk/templates/etcd-svc.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#


apiVersion: v1
kind: Service
metadata:
  name: openwhisk-etcd
  labels:
    name: openwhisk-etcd
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
spec:
  selector:
    name: openwhisk-etcd
  ports:
    - port: 2379
      name: etcd
---
# Source: edge-chart/charts/openwhisk/templates/grafana-svc.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#


apiVersion: v1
kind: Service
metadata:
  name: openwhisk-grafana
  labels:
    name: openwhisk-grafana
spec:
  selector:
    name: openwhisk-grafana
  ports:
  - port: 3000
    name: http
---
# Source: edge-chart/charts/openwhisk/templates/kafka-svc.yaml
apiVersion: v1
kind: Service
metadata:
  name: openwhisk-kafka
  labels:
    name: openwhisk-kafka
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
spec:
  selector:
    name: openwhisk-kafka
  clusterIP: None
  ports:
  - name: broker
    port: 9092
---
# Source: edge-chart/charts/openwhisk/templates/nginx-svc.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

apiVersion: v1
kind: Service
metadata:
  name: openwhisk-nginx
  labels:
    name: openwhisk-nginx
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
spec:
  type: NodePort
  selector:
    name: openwhisk-nginx
  ports:
    - port: 80
      name: http
      targetPort: http
    - port: 443
      nodePort: 30002
      name: https
      targetPort: https
---
# Source: edge-chart/charts/openwhisk/templates/prometheus-svc.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#


apiVersion: v1
kind: Service
metadata:
  name: openwhisk-prometheus-server
  annotations:
    prometheus.io/scrape: 'true'
    prometheus.io/port:   '9090'
spec:
  selector:
    name: openwhisk-prometheus-server
  ports:
    - port: 9090
---
# Source: edge-chart/charts/openwhisk/templates/redis-svc.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#


apiVersion: v1
kind: Service
metadata:
  name: openwhisk-redis
  labels:
    name: openwhisk-redis
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
spec:
  selector:
    name: openwhisk-redis
  ports:
    - port: 6379
      name: redis
---
# Source: edge-chart/charts/openwhisk/templates/user-events-svc.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#


apiVersion: v1
kind: Service
metadata:
  name: openwhisk-user-events
  labels:
    name: openwhisk-user-events
spec:
  selector:
    name: openwhisk-user-events
  ports:
  - port: 9095
    name: http
---
# Source: edge-chart/charts/openwhisk/templates/zookeeper-svc.yaml
apiVersion: v1
kind: Service
metadata:
  name: openwhisk-zookeeper
  labels:
    name: openwhisk-zookeeper
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
spec:
  selector:
    name: openwhisk-zookeeper
  clusterIP: None
  ports:
    - port: 2181
      name: "zookeeper"
    - port: 2888
      name: "server"
    - port: 3888
      name: "leader-election"
---
# Source: edge-chart/charts/openwhisk/templates/wskadmin-pod.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

apiVersion: v1
kind: Pod
metadata:
  name: openwhisk-wskadmin
  labels:
    name: openwhisk-wskadmin
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
spec:
  restartPolicy: Always
  
  containers:
  - name: wskadmin
    image: "openwhisk/ow-utils:ef725a6"
    imagePullPolicy: "IfNotPresent"
    command: ["/bin/bash", "-c", "tail -f /dev/null"]
    env:
    - name: "WHISK_LOGS_DIR"
      value: "/var/log"
      # Provider database configuration
    # Use the internally deployed CouchDB service for the providers
    - name: "DB_HOST"
      valueFrom:
        configMapKeyRef:
          name: openwhisk-db.config
          key: db_host
    - name: "DB_PROTOCOL"
      valueFrom:
        configMapKeyRef:
          name: openwhisk-db.config
          key: db_protocol
    - name: "DB_PORT"
      valueFrom:
        configMapKeyRef:
          name: openwhisk-db.config
          key: db_port
    - name: "DB_USERNAME"
      valueFrom:
        secretKeyRef:
          name: openwhisk-db.auth
          key: db_username
    - name: "DB_PASSWORD"
      valueFrom:
        secretKeyRef:
          name: openwhisk-db.auth
          key: db_password
    
    - name: "DB_WHISK_ACTIONS"
      valueFrom:
          configMapKeyRef:
            name: openwhisk-db.config
            key: db_whisk_actions
    
    - name: "DB_WHISK_AUTHS"
      valueFrom:
        configMapKeyRef:
          name: openwhisk-db.config
          key: db_whisk_auths
    
    - name: "DB_WHISK_ACTIVATIONS"
      valueFrom:
          configMapKeyRef:
              name: openwhisk-db.config
              key: db_whisk_activations
---
# Source: edge-chart/charts/mosquitto/templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: openwhisk-mosquitto
  labels:
    name: mosquitto
    helm.sh/chart: mosquitto-0.1.0
    app.kubernetes.io/name: mosquitto
    app.kubernetes.io/instance: openwhisk
    app.kubernetes.io/version: "2.0.15"
    app.kubernetes.io/managed-by: Helm
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: mosquitto
      app.kubernetes.io/instance: openwhisk
  template:
    metadata:
      labels:
        name: mosquitto
        app.kubernetes.io/name: mosquitto
        app.kubernetes.io/instance: openwhisk
    spec:
      serviceAccountName: openwhisk-mosquitto
      securityContext:
        fsGroup: 1883
      containers:
        - name: mosquitto
          securityContext:
            capabilities:
              add:
              - NET_BIND_SERVICE
              drop:
              - ALL
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1883
          image: "eclipse-mosquitto:2.0.15"
          imagePullPolicy: IfNotPresent
          ports:
            - name: mqtt
              containerPort: 1883
              protocol: TCP
            - name: mqtt-ws
              containerPort: 9001
              protocol: TCP
          volumeMounts:
            - name: config
              mountPath: /mosquitto/config/mosquitto.conf
              subPath: mosquitto.conf
              readOnly: true
            - name: secrets
              mountPath: /mosquitto/config/passwords.conf
              subPath: passwords.conf
              readOnly: true
            - name: config
              mountPath: /mosquitto/config/acl.conf
              subPath: acl.conf
              readOnly: true
          livenessProbe:
            tcpSocket:
              port: 1883
          readinessProbe:
            tcpSocket:
              port: 1883
          resources:
            limits:
              cpu: 100m
              memory: 128Mi
            requests:
              cpu: 100m
              memory: 128Mi
      volumes:
        - name: config
          configMap:
            name: openwhisk-mosquitto
        - name: secrets
          secret:
            secretName: openwhisk-mosquitto
---
# Source: edge-chart/charts/mqtt-provider/templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mqtt-provider
  labels:
    user-action-pod: "true"
    name: mqtt-provider
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mqtt-service-provider
  template:
    metadata:
      labels:
        app: mqtt-service-provider
        user-action-pod: "true"
        name: mqtt-provider
    spec:
      containers:
      - name: mqtt-service-provider
        image: docker.io/giuliabianchi1408/mqtt_service_provider:latest
        volumeMounts:
        - name: volume-configmap
          mountPath: /data/env-variables
          subPath: env-variables
        env:
          - name: COUCHDB_USER 
            valueFrom:
              configMapKeyRef:
                name: mqtt-provider-configmap
                key: couchdbUsername
          - name: COUCHDB_PASS 
            valueFrom:
              configMapKeyRef:
                name: mqtt-provider-configmap
                key: couchdbPassword
          - name: COUCHDB_HOST
            valueFrom:
              configMapKeyRef:
                name: mqtt-provider-configmap
                key: couchdbGateway
          - name: COUCHDB_HOST_PORT 
            valueFrom:
              configMapKeyRef:
                name: mqtt-provider-configmap
                key: couchdbExtPort
          - name: OPENWHISK_API_HOSTNAME
            valueFrom:
              configMapKeyRef:
                name: mqtt-provider-configmap
                key: apiHost
      volumes:
      - name: volume-configmap
        configMap:
          name: mqtt-provider-configmap
---
# Source: edge-chart/charts/openwhisk/templates/apigateway-pod.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

apiVersion: apps/v1
kind: Deployment
metadata:
  name: openwhisk-apigateway
  labels:
    name: openwhisk-apigateway
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
spec:
  replicas: 1
  selector:
    matchLabels:
      name: openwhisk-apigateway
  template:
    metadata:
      labels:
        name: openwhisk-apigateway
        heritage: "Helm"
        release: "openwhisk"
        chart: "openwhisk-1.0.1"
        app: openwhisk-openwhisk
    spec:
      restartPolicy: Always
      affinity:
        # prefer to not run on an invoker node (only prefer because of single node clusters)
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            preference:
              matchExpressions:
              - key: openwhisk-role
                operator: NotIn
                values:
                - invoker
          - weight: 80
            preference:
              matchExpressions:
              - key: openwhisk-role
                operator: In
                values:
                - core
        # Fault tolerance: prevent multiple instances of openwhisk-apigateway from running on the same node
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: name
                operator: In
                values:
                - openwhisk-apigateway
            topologyKey: "kubernetes.io/hostname"
      tolerations:
        - key: "openwhisk-role"
          operator: "Equal"
          value: core
          effect: "NoSchedule"

      
      containers:
        - name: apigateway
          imagePullPolicy: "IfNotPresent"
          image: "openwhisk/apigateway:1.0.0"
          ports:
          - name: mgmt
            containerPort: 8080
          - name: api
            containerPort: 9000
          env:
          - name: "REDIS_HOST"
            value: "openwhisk-redis.openwhisk-second.svc.cluster.local"
          - name: "REDIS_PORT"
            value: "6379"
          - name: "PUBLIC_GATEWAY_URL"
            valueFrom:
              configMapKeyRef:
                name: openwhisk-whisk.config
                key: whisk_external_api_host_url
          - name: "BACKEND_HOST"
            valueFrom:
              configMapKeyRef:
                name: openwhisk-whisk.config
                key: whisk_internal_api_host_url
---
# Source: edge-chart/charts/openwhisk/templates/grafana-pod.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#


apiVersion: apps/v1
kind: Deployment
metadata:
  name: openwhisk-grafana
  labels:
    name: openwhisk-grafana
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
spec:
  replicas: 1
  selector:
    matchLabels:
      name: openwhisk-grafana
  template:
    metadata:
      labels:
        name: openwhisk-grafana
        heritage: "Helm"
        release: "openwhisk"
        chart: "openwhisk-1.0.1"
        app: openwhisk-openwhisk
    spec:
      restartPolicy: Always
      affinity:
        # prefer to not run on an invoker node (only prefer because of single node clusters)
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            preference:
              matchExpressions:
              - key: openwhisk-role
                operator: NotIn
                values:
                - invoker
          - weight: 80
            preference:
              matchExpressions:
              - key: openwhisk-role
                operator: In
                values:
                - core
        # Fault tolerance: prevent multiple instances of openwhisk-grafana from running on the same node
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: name
                operator: In
                values:
                - openwhisk-grafana
            topologyKey: "kubernetes.io/hostname"
      tolerations:
        - key: "openwhisk-role"
          operator: "Equal"
          value: core
          effect: "NoSchedule"

      initContainers:
      - name: download-dashboards
        image: "appropriate/curl:latest"
        imagePullPolicy: Always
        command: ["sh", "/etc/grafana/download_dashboards.sh"]
        resources:
          limits:
            cpu: 100m
            memory: 128Mi
        volumeMounts:
        - name: grafana-dashboard-volume
          mountPath: /var/lib/grafana/dashboards
        - name: grafana-download-volume
          mountPath: "/etc/grafana"
      containers:
        - name: grafana
          image: "grafana/grafana:6.3.0"
          env:
          - name: "GF_AUTH_ANONYMOUS_ENABLED"
            value: "true"
          - name: "GF_SECURITY_ADMIN_PASSWORD"
            value: admin
          - name: "GF_PATHS_PROVISIONING"
            value: "/var/lib/grafana/config"
          - name: "GF_USERS_ALLOW_SIGN_UP"
            value: "false"
          - name: "GF_SERVER_ROOT_URL"
            value: "%(protocol)s://%(domain)s/monitoring"
          - name: "GF_SERVER_SERVE_FROM_SUB_PATH"
            value: "true"

          ports:
            - containerPort: 3000
          livenessProbe:
            httpGet:
              path: /api/health
              port: 3000
            initialDelaySeconds: 30
            timeoutSeconds: 5
          readinessProbe:
            httpGet:
              path: /api/health
              port: 3000
          volumeMounts:
          - name: grafana-datasource-config-volume
            mountPath: /var/lib/grafana/config/datasources
          - name: grafana-dashboard-config-volume
            mountPath: /var/lib/grafana/config/dashboards
          - name: grafana-dashboard-volume
            mountPath: /var/lib/grafana/dashboards
      volumes:
      - name: grafana-datasource-config-volume
        configMap:
          name: "openwhisk-grafana-ds-cfg"
      - name: grafana-dashboard-config-volume
        configMap:
          name: "openwhisk-grafana-dsb-cfg"
      - name: grafana-download-volume
        configMap:
          name: "openwhisk-grafana-download"
      - name: grafana-dashboard-volume
        emptyDir: {}
---
# Source: edge-chart/charts/openwhisk/templates/nginx-pod.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

apiVersion: apps/v1
kind: Deployment
metadata:
  name: openwhisk-nginx
  labels:
    name: openwhisk-nginx
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
spec:
  replicas: 1
  selector:
    matchLabels:
      name: openwhisk-nginx
  template:
    metadata:
      labels:
        name: openwhisk-nginx
        heritage: "Helm"
        release: "openwhisk"
        chart: "openwhisk-1.0.1"
        app: openwhisk-openwhisk
    spec:
      restartPolicy: Always
      affinity:
        # prefer to not run on an invoker node (only prefer because of single node clusters)
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            preference:
              matchExpressions:
              - key: openwhisk-role
                operator: NotIn
                values:
                - invoker
          - weight: 80
            preference:
              matchExpressions:
              - key: openwhisk-role
                operator: In
                values:
                - edge
        # Fault tolerance: prevent multiple instances of openwhisk-nginx from running on the same node
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: name
                operator: In
                values:
                - openwhisk-nginx
            topologyKey: "kubernetes.io/hostname"
      tolerations:
        - key: "openwhisk-role"
          operator: "Equal"
          value: edge
          effect: "NoSchedule"

      volumes:
      - name: nginx-certs
        secret:
          secretName: openwhisk-nginx
      - name: nginx-conf
        configMap:
          name: openwhisk-nginx
      - name: logs
        emptyDir: {}
      
      initContainers:
      # Wait for a controller to be up (which implies kafka, zookeeper, couchdb are all up as well).
      - name: "wait-for-controller"
        image: "busybox:latest"
        imagePullPolicy: "IfNotPresent"
        env:
        - name: "READINESS_URL"
          value: http://openwhisk-controller.openwhisk-second.svc.cluster.local:8080/ping
        command: ["sh", "-c", "result=1; until [ $result -eq 0 ]; do echo 'Checking controller readiness'; wget -T 5 --spider $READINESS_URL; result=$?; sleep 1; done; echo 'Success: controller is ready'"]
      containers:
      - name: nginx
        image: "nginx:1.21.1"
        imagePullPolicy: "IfNotPresent"
        ports:
        - name: http
          containerPort: 80
        - name: https
          containerPort: 443
        volumeMounts:
        - name: nginx-conf
          mountPath: "/etc/nginx/nginx.conf"
          subPath: "nginx.conf"
        - name: nginx-certs
          mountPath: "/etc/nginx/certs"
        - name: logs
          mountPath: "/logs"
---
# Source: edge-chart/charts/openwhisk/templates/provider-alarm-pod.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
apiVersion: apps/v1
kind: Deployment
metadata:
  name: openwhisk-alarmprovider
  labels:
    name: openwhisk-alarmprovider
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
spec:
  replicas: 1
  selector:
    matchLabels:
      name: openwhisk-alarmprovider
  strategy:
    type: "Recreate"
  template:
    metadata:
      labels:
        name: openwhisk-alarmprovider
        heritage: "Helm"
        release: "openwhisk"
        chart: "openwhisk-1.0.1"
        app: openwhisk-openwhisk
    spec:
      restartPolicy: Always
      volumes:
        - name: alarm-logs
          persistentVolumeClaim:
            claimName: openwhisk-alarmprovider-pvc
      affinity:
        # prefer to not run on an invoker node (only prefer because of single node clusters)
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            preference:
              matchExpressions:
              - key: openwhisk-role
                operator: NotIn
                values:
                - invoker
          - weight: 80
            preference:
              matchExpressions:
              - key: openwhisk-role
                operator: In
                values:
                - provider

      initContainers:
      # Wait for a controller to be up (which implies couchdb is up as well).
      - name: "wait-for-controller"
        image: "busybox:latest"
        imagePullPolicy: "IfNotPresent"
        env:
        - name: "READINESS_URL"
          value: http://openwhisk-controller.openwhisk-second.svc.cluster.local:8080/ping
        command: ["sh", "-c", "result=1; until [ $result -eq 0 ]; do echo 'Checking controller readiness'; wget -T 5 --spider $READINESS_URL; result=$?; sleep 1; done; echo 'Success: controller is ready'"]
      
      containers:
      - name: alarmprovider
        image: "openwhisk/alarmprovider:2.3.0"
        imagePullPolicy: "IfNotPresent"
        ports:
        - name: alarmprovider
          containerPort: 8080
        env:
        - name: "DB_PROTOCOL"
          valueFrom:
            configMapKeyRef:
              name: openwhisk-db.config
              key: db_protocol
        - name: "DB_HOST"
          valueFrom:
            configMapKeyRef:
              name: openwhisk-db.config
              key: db_host_port
        - name: "DB_USERNAME"
          valueFrom:
            secretKeyRef:
              name: openwhisk-db.auth
              key: db_username
        - name: "DB_PASSWORD"
          valueFrom:
            secretKeyRef:
              name: openwhisk-db.auth
              key: db_password
        - name: "DB_PREFIX"
          value: "alm"
        - name: "ROUTER_HOST"
          valueFrom:
            configMapKeyRef:
              name: openwhisk-whisk.config
              key: whisk_external_api_host_nameAndPort
        - name: "ENDPOINT_AUTH"
          valueFrom:
            configMapKeyRef:
              name: openwhisk-whisk.config
              key: whisk_external_api_host_nameAndPort
        volumeMounts:
          - name: alarm-logs
            mountPath: /logs
---
# Source: edge-chart/charts/openwhisk/templates/redis-pod.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#


apiVersion: apps/v1
kind: Deployment
metadata:
  name: openwhisk-redis
  labels:
    name: openwhisk-redis
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
spec:
  replicas: 1
  selector:
    matchLabels:
      name: openwhisk-redis
  strategy:
    type: "Recreate"
  template:
    metadata:
      labels:
        name: openwhisk-redis
        heritage: "Helm"
        release: "openwhisk"
        chart: "openwhisk-1.0.1"
        app: openwhisk-openwhisk
    spec:
      restartPolicy: Always
      affinity:
        # prefer to not run on an invoker node (only prefer because of single node clusters)
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            preference:
              matchExpressions:
              - key: openwhisk-role
                operator: NotIn
                values:
                - invoker
          - weight: 80
            preference:
              matchExpressions:
              - key: openwhisk-role
                operator: In
                values:
                - core
        # Fault tolerance: prevent multiple instances of "openwhisk-redis" from running on the same node
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: name
                operator: In
                values:
                - "openwhisk-redis"
            topologyKey: "kubernetes.io/hostname"
      tolerations:
        - key: "openwhisk-role"
          operator: "Equal"
          value: core
          effect: "NoSchedule"
      volumes:
      - name: redis-data
        persistentVolumeClaim:
          claimName: openwhisk-redis-pvc
      initContainers:
      - name: redis-init
        image: "busybox:latest"
        command:
          - chown
          - -v
          - -R
          - 999:999
          - /data
        volumeMounts:
        - mountPath: /data
          name: redis-data
          readOnly: false
      
      containers:
        - name: redis
          image: "redis:4.0"
          imagePullPolicy: "IfNotPresent"
          volumeMounts:
          - mountPath: /data
            name: redis-data
            readOnly: false
          ports:
          - name: redis
            containerPort: 6379
---
# Source: edge-chart/charts/openwhisk/templates/user-events-pod.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#


apiVersion: apps/v1
kind: Deployment
metadata:
  name: openwhisk-user-events
  labels:
    name: openwhisk-user-events
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
spec:
  replicas: 1
  selector:
    matchLabels:
      name: openwhisk-user-events
  template:
    metadata:
      labels:
        name: openwhisk-user-events
        heritage: "Helm"
        release: "openwhisk"
        chart: "openwhisk-1.0.1"
        app: openwhisk-openwhisk
      annotations:
        prometheus.io/scrape: 'true'
        prometheus.io/port:   '9095'
    spec:
      restartPolicy: Always
      affinity:
        # prefer to not run on an invoker node (only prefer because of single node clusters)
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            preference:
              matchExpressions:
              - key: openwhisk-role
                operator: NotIn
                values:
                - invoker
          - weight: 80
            preference:
              matchExpressions:
              - key: openwhisk-role
                operator: In
                values:
                - core
        # Fault tolerance: prevent multiple instances of openwhisk-user-events from running on the same node
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: name
                operator: In
                values:
                - openwhisk-user-events
            topologyKey: "kubernetes.io/hostname"
      tolerations:
        - key: "openwhisk-role"
          operator: "Equal"
          value: core
          effect: "NoSchedule"

      containers:
        - name: user-events
          imagePullPolicy: "IfNotPresent"
          image: "openwhisk/user-events:ef725a6"
          env:
          - name: "KAFKA_HOSTS"
            value: "openwhisk-kafka-0.openwhisk-kafka.openwhisk-second.svc.cluster.local:9092"
          - name: "CONFIG_whisk_kafka_replicationFactor"
            value: ""
          - name: "CONFIG_whisk_kafka_topics_prefix"
            value: ""
          - name: "CONFIG_whisk_kafka_topics_cacheInvalidation_retentionBytes"
            value: ""
          - name: "CONFIG_whisk_kafka_topics_cacheInvalidation_retentionMs"
            value: ""
          - name: "CONFIG_whisk_kafka_topics_cacheInvalidation_segmentBytes"
            value: ""
          - name: "CONFIG_whisk_kafka_topics_completed_retentionBytes"
            value: ""
          - name: "CONFIG_whisk_kafka_topics_completed_retentionMs"
            value: ""
          - name: "CONFIG_whisk_kafka_topics_completed_segmentBytes"
            value: ""
          - name: "CONFIG_whisk_kafka_topics_events_retentionBytes"
            value: ""
          - name: "CONFIG_whisk_kafka_topics_events_retentionMs"
            value: ""
          - name: "CONFIG_whisk_kafka_topics_events_segmentBytes"
            value: ""
          - name: "CONFIG_whisk_kafka_topics_health_retentionBytes"
            value: ""
          - name: "CONFIG_whisk_kafka_topics_health_retentionMs"
            value: ""
          - name: "CONFIG_whisk_kafka_topics_health_segmentBytes"
            value: ""
          
          - name: "CONFIG_whisk_kafka_topics_invoker_retentionBytes"
            value: ""
          - name: "CONFIG_whisk_kafka_topics_invoker_retentionMs"
            value: ""
          - name: "CONFIG_whisk_kafka_topics_invoker_segmentBytes"
            value: ""
          
          - name: "CONFIG_whisk_kafka_topics_scheduler_retentionBytes"
            value: ""
          - name: "CONFIG_whisk_kafka_topics_scheduler_retentionMs"
            value: ""
          - name: "CONFIG_whisk_kafka_topics_scheduler_segmentBytes"
            value: ""
          
          - name: "CONFIG_whisk_kafka_topics_creationAck_retentionBytes"
            value: ""
          - name: "CONFIG_whisk_kafka_topics_creationAck_retentionMs"
            value: ""
          - name: "CONFIG_whisk_kafka_topics_creationAck_segmentBytes"
            value: ""
          ports:
            - containerPort: 9095
          livenessProbe:
            httpGet:
              path: /ping
              port: 9095
            initialDelaySeconds: 30
            timeoutSeconds: 5
          readinessProbe:
            httpGet:
              path: /ping
              port: 9095
---
# Source: edge-chart/charts/influxdb2/templates/statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: openwhisk-influxdb2
  labels:
    app.kubernetes.io/name: influxdb2
    app.kubernetes.io/instance: openwhisk
    app.kubernetes.io/version: "2.3.0"
    app.kubernetes.io/managed-by: Helm
    helm.sh/chart: influxdb2-2.1.1
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: influxdb2
      app.kubernetes.io/instance: openwhisk
  serviceName: "openwhisk-influxdb2"
  template:
    metadata:
      labels:
        app.kubernetes.io/name: influxdb2
        app.kubernetes.io/instance: openwhisk
        name: influxdb
        user-action-pod: "true"
    spec:
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: openwhisk-influxdb2
      serviceAccountName: openwhisk-influxdb2
      containers:
        - name: influxdb2
          image: "influxdb:2.3.0-alpine"
          imagePullPolicy: IfNotPresent
          ports:
            - name: http
              containerPort: 8086
              protocol: TCP
          env:
            # Automated setup will not run if an existing boltdb file is found at the configured path.
            # This behavior allows for the InfluxDB container to reboot post-setup without encountering "DB is already set up" errors.
            - name: DOCKER_INFLUXDB_INIT_MODE
              value: setup
            # The username to set for the system's initial super-user (Required).
            - name: DOCKER_INFLUXDB_INIT_USERNAME
              value: admin
            # The password to set for the system's inital super-user (Required).
            - name: DOCKER_INFLUXDB_INIT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: openwhisk-influxdb2-auth
                  key: admin-password
            # The name to set for the system's initial organization (Required).
            - name: DOCKER_INFLUXDB_INIT_ORG
              value: influxdata
            # The name to set for the system's initial bucket (Required).
            - name: DOCKER_INFLUXDB_INIT_BUCKET
              value: http://openwhisk-influxdb2:80
            # The duration the system's initial bucket should retain data. If not set, the initial bucket will retain data forever.
            - name: DOCKER_INFLUXDB_INIT_RETENTION
              value: 0s
            # The authentication token to associate with the system's initial super-user. If not set, a token will be auto-generated by the system.
            - name: DOCKER_INFLUXDB_INIT_ADMIN_TOKEN
              valueFrom:
                secretKeyRef:
                  name: openwhisk-influxdb2-auth
                  key: admin-token
            # Path to the BoltDB database.
            - name: INFLUXD_BOLT_PATH
              value: /var/lib/influxdb2/influxd.bolt
            # Path to persistent storage engine files where InfluxDB stores all Time-Structure Merge Tree (TSM) data on disk.
            - name: INFLUXD_ENGINE_PATH
              value: /var/lib/influxdb2
          livenessProbe:
            httpGet:
              path: /health
              port: http
              scheme: HTTP
            initialDelaySeconds: 60
            periodSeconds: 10
            timeoutSeconds: 100
            failureThreshold: 1000
          readinessProbe:
            httpGet:
              path: /health
              port: http
              scheme: HTTP
            initialDelaySeconds: 60
            periodSeconds: 10
            timeoutSeconds: 100
            successThreshold: 1
            failureThreshold: 1000
          volumeMounts:
          - name: data
            mountPath: /var/lib/influxdb2
            subPath: 
          resources:
            {}
---
# Source: edge-chart/charts/openwhisk/templates/controller-pod.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: openwhisk-controller
  labels:
    name: openwhisk-controller
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
spec:
  serviceName: openwhisk-controller
  podManagementPolicy: "Parallel"
  replicas: 1
  selector:
    matchLabels:
      name: openwhisk-controller
  template:
    metadata:
      labels:
        name: openwhisk-controller
        heritage: "Helm"
        release: "openwhisk"
        chart: "openwhisk-1.0.1"
        app: openwhisk-openwhisk
      annotations:
        prometheus.io/scrape: 'true'
        prometheus.io/port:   '8080'

    spec:
      serviceAccountName: openwhisk-core
      restartPolicy: Always
      affinity:
        # prefer to not run on an invoker node (only prefer because of single node clusters)
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            preference:
              matchExpressions:
              - key: openwhisk-role
                operator: NotIn
                values:
                - invoker
          - weight: 80
            preference:
              matchExpressions:
              - key: openwhisk-role
                operator: In
                values:
                - core
        # Fault tolerance: prevent multiple instances of openwhisk-controller from running on the same node
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: name
                operator: In
                values:
                - openwhisk-controller
            topologyKey: "kubernetes.io/hostname"
      tolerations:
        - key: "openwhisk-role"
          operator: "Equal"
          value: core
          effect: "NoSchedule"

      initContainers:
      # The controller must wait for kafka and/or couchdb to be ready before it starts
      - name: "wait-for-kafka"
        image: "openwhisk/ow-utils:ef725a6"
        imagePullPolicy: "IfNotPresent"
        command: ["sh", "-c", 'cacert="/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"; token="$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)"; while true; do rc=$(curl -sS --cacert $cacert --header "Authorization: Bearer $token" https://kubernetes.default.svc/api/v1/namespaces/openwhisk-second/endpoints/openwhisk-kafka | jq -r ".subsets[].addresses | length"); echo "num ready kafka endpoints is $rc"; if [ $rc -gt 0 ]; then echo "Success: ready kafka endpoint!"; break; fi; echo "kafka not ready yet; sleeping for 3 seconds"; sleep 3; done;']
      
      # if not db.wipeAndInit, the external db must already be ready; so no need for init container
      # The lean controller requires invoker volumes mounts
      

      containers:
      - name: controller
        imagePullPolicy: "IfNotPresent"
        image: "openwhisk/controller:ef725a6"
        command: ["/bin/bash", "-c", "/init.sh `hostname | awk -F '-' '{print $NF}'`"]
        ports:
        - name: controller
          containerPort: 8080
        - name: akka-remoting
          containerPort: 25520
        - name: akka-mgmt-http
          containerPort: 19999
        livenessProbe:
          httpGet:
            path: "/ping"
            port: 8080
            scheme: "HTTP"
          initialDelaySeconds: 100
          periodSeconds: 10
          timeoutSeconds: 1000
        readinessProbe:
          httpGet:
            path: "/ping"
            port: 8080
            scheme: "HTTP"
          initialDelaySeconds: 100
          periodSeconds: 10
          timeoutSeconds: 1000
        env:
        - name: "PORT"
          value: "8080"

        - name: "TZ"
          value: "UTC"

        - name: "POD_IP"
          valueFrom:
            fieldRef:
              fieldPath: status.podIP

        - name:  "CONFIG_whisk_info_date"
          valueFrom:
            configMapKeyRef:
              name: openwhisk-whisk.config
              key: whisk_info_date
        - name: "CONFIG_whisk_info_buildNo"
          valueFrom:
            configMapKeyRef:
              name: openwhisk-whisk.config
              key: whisk_info_buildNo

        # Java options
        - name: "JAVA_OPTS"
          value: "-Xmx1024M "

        # specific controller arguments
        - name: "CONTROLLER_OPTS"
          value: " "

        # action runtimes
        - name: "RUNTIMES_MANIFEST"
          value: "{\n    \"runtimes\": {\n        \"nodejs\": [\n            {\n                \"kind\": \"nodejs:14\",\n                \"default\": true,\n                \"image\": {\n                    \"prefix\": \"giuliabianchi1408\",\n                    \"name\": \"action-nodejs-v14\",\n                    \"tag\": \"latest\"\n                },\n                \"deprecated\": false,\n                \"attached\": {\n                    \"attachmentName\": \"codefile\",\n                    \"attachmentType\": \"text/plain\"\n                },\n                \"stemCells\": [\n                    {\n                        \"initialCount\": 2,\n                        \"memory\": \"256 MB\",\n                        \"reactive\": {\n                            \"minCount\": 1,\n                            \"maxCount\": 4,\n                            \"ttl\": \"2 minutes\",\n                            \"threshold\": 1,\n                            \"increment\": 1\n                        }\n                    }\n                ]\n            },\n            {\n                \"kind\": \"nodejs:16\",\n                \"default\": false,\n                \"image\": {\n                    \"prefix\": \"openwhisk\",\n                    \"name\": \"action-nodejs-v16\",\n                    \"tag\": \"1.20.0\"\n                },\n                \"deprecated\": false,\n                \"attached\": {\n                    \"attachmentName\": \"codefile\",\n                    \"attachmentType\": \"text/plain\"\n                }\n            }\n        ],\n        \"python\": [\n            {\n                \"kind\": \"python:3\",\n                \"default\": true,\n                \"image\": {\n                    \"prefix\": \"openwhisk\",\n                    \"name\": \"action-python-v3.7\",\n                    \"tag\": \"1.17.0\"\n                },\n                \"deprecated\": false,\n                \"attached\": {\n                    \"attachmentName\": \"codefile\",\n                    \"attachmentType\": \"text/plain\"\n                }\n            }\n        ],\n        \"swift\": [\n            {\n                \"kind\": \"swift:4.2\",\n                \"default\": true,\n                \"image\": {\n                    \"prefix\": \"openwhisk\",\n                    \"name\": \"action-swift-v4.2\",\n                    \"tag\": \"1.17.0\"\n                },\n                \"deprecated\": false,\n                \"attached\": {\n                    \"attachmentName\": \"codefile\",\n                    \"attachmentType\": \"text/plain\"\n                }\n            },\n            {\n                \"kind\": \"swift:5.1\",\n                \"default\": false,\n                \"image\": {\n                    \"prefix\": \"openwhisk\",\n                    \"name\": \"action-swift-v5.1\",\n                    \"tag\": \"1.17.0\"\n                },\n                \"deprecated\": false,\n                \"attached\": {\n                    \"attachmentName\": \"codefile\",\n                    \"attachmentType\": \"text/plain\"\n                }\n            },\n            {\n                \"kind\": \"swift:5.3\",\n                \"default\": false,\n                \"image\": {\n                    \"prefix\": \"openwhisk\",\n                    \"name\": \"action-swift-v5.3\",\n                    \"tag\": \"1.17.0\"\n                },\n                \"deprecated\": false,\n                \"attached\": {\n                    \"attachmentName\": \"codefile\",\n                    \"attachmentType\": \"text/plain\"\n                }\n            },\n            {\n                \"kind\": \"swift:5.4\",\n                \"default\": false,\n                \"image\": {\n                    \"prefix\": \"openwhisk\",\n                    \"name\": \"action-swift-v5.4\",\n                    \"tag\": \"1.17.0\"\n                },\n                \"deprecated\": false,\n                \"attached\": {\n                    \"attachmentName\": \"codefile\",\n                    \"attachmentType\": \"text/plain\"\n                }\n            }\n        ],\n        \"java\": [\n            {\n                \"kind\": \"java:8\",\n                \"default\": true,\n                \"image\": {\n                    \"prefix\": \"openwhisk\",\n                    \"name\": \"java8action\",\n                    \"tag\": \"1.17.0\"\n                },\n                \"deprecated\": false,\n                \"attached\": {\n                    \"attachmentName\": \"jarfile\",\n                    \"attachmentType\": \"application/java-archive\"\n                },\n                \"requireMain\": true\n            }\n        ],\n        \"php\": [\n            {\n                \"kind\": \"php:7.3\",\n                \"default\": false,\n                \"deprecated\": false,\n                \"image\": {\n                    \"prefix\": \"openwhisk\",\n                    \"name\": \"action-php-v7.3\",\n                    \"tag\": \"1.17.0\"\n                },\n                \"attached\": {\n                    \"attachmentName\": \"codefile\",\n                    \"attachmentType\": \"text/plain\"\n                }\n            },\n            {\n                \"kind\": \"php:7.4\",\n                \"default\": true,\n                \"deprecated\": false,\n                \"image\": {\n                    \"prefix\": \"openwhisk\",\n                    \"name\": \"action-php-v7.4\",\n                    \"tag\": \"1.17.0\"\n                },\n                \"attached\": {\n                    \"attachmentName\": \"codefile\",\n                    \"attachmentType\": \"text/plain\"\n                }\n            },\n            {\n                \"kind\": \"php:8.0\",\n                \"default\": false,\n                \"deprecated\": false,\n                \"image\": {\n                    \"prefix\": \"openwhisk\",\n                    \"name\": \"action-php-v7.4\",\n                    \"tag\": \"1.17.0\"\n                },\n                \"attached\": {\n                    \"attachmentName\": \"codefile\",\n                    \"attachmentType\": \"text/plain\"\n                }\n            }\n        ],\n        \"ruby\": [\n            {\n                \"kind\": \"ruby:2.5\",\n                \"default\": true,\n                \"deprecated\": false,\n                \"attached\": {\n                    \"attachmentName\": \"codefile\",\n                    \"attachmentType\": \"text/plain\"\n                },\n                \"image\": {\n                    \"prefix\": \"openwhisk\",\n                    \"name\": \"action-ruby-v2.5\",\n                    \"tag\": \"1.17.0\"\n                }\n            }\n        ],\n        \"go\": [\n            {\n                \"kind\": \"go:1.17\",\n                \"default\": true,\n                \"deprecated\": false,\n                \"attached\": {\n                    \"attachmentName\": \"codefile\",\n                    \"attachmentType\": \"text/plain\"\n                },\n                \"image\": {\n                    \"prefix\": \"openwhisk\",\n                    \"name\": \"action-golang-v1.17\",\n                    \"tag\": \"1.20.0\"\n                }\n            }\n        ],\n        \"rust\": [\n            {\n                \"kind\": \"rust:1.34\",\n                \"default\": true,\n                \"deprecated\": false,\n                \"attached\": {\n                    \"attachmentName\": \"codefile\",\n                    \"attachmentType\": \"text/plain\"\n                },\n                \"image\": {\n                    \"prefix\": \"openwhisk\",\n                    \"name\": \"action-rust-v1.34\",\n                    \"tag\": \"1.3.0\"\n                }\n            }\n        ],\n        \"dotnet\": [\n            {\n                \"kind\": \"dotnet:2.2\",\n                \"default\": true,\n                \"deprecated\": false,\n                \"requireMain\": true,\n                \"image\": {\n                    \"prefix\": \"openwhisk\",\n                    \"name\": \"action-dotnet-v2.2\",\n                    \"tag\": \"1.16.0\"\n                },\n                \"attached\": {\n                    \"attachmentName\": \"codefile\",\n                    \"attachmentType\": \"text/plain\"\n                }\n            },\n            {\n                \"kind\": \"dotnet:3.1\",\n                \"default\": false,\n                \"deprecated\": false,\n                \"requireMain\": true,\n                \"image\": {\n                    \"prefix\": \"openwhisk\",\n                    \"name\": \"action-dotnet-v3.1\",\n                    \"tag\": \"1.16.0\"\n                },\n                \"attached\": {\n                    \"attachmentName\": \"codefile\",\n                    \"attachmentType\": \"text/plain\"\n                }\n            }\n        ],\n        \"ballerina\": [\n            {\n                \"kind\": \"ballerina:0.990\",\n                \"default\": true,\n                \"image\": {\n                    \"prefix\": \"openwhisk\",\n                    \"name\": \"action-ballerina-v0.990.2\",\n                    \"tag\": \"nightly\"\n                },\n                \"deprecated\": false,\n                \"attached\": {\n                    \"attachmentName\": \"codefile\",\n                    \"attachmentType\": \"text/plain\"\n                }\n            }\n        ]\n    },\n    \"blackboxes\": [\n        {\n            \"prefix\": \"openwhisk\",\n            \"name\": \"dockerskeleton\",\n            \"tag\": \"1.14.0\"\n        }\n    ]\n}\n"

        # scheduler settings


        # Action limits
        - name: "LIMITS_ACTIONS_INVOKES_PERMINUTE"
          value: "60"
        - name: "LIMITS_ACTIONS_INVOKES_CONCURRENT"
          value: "30"
        - name: "LIMITS_TRIGGERS_FIRES_PERMINUTE"
          value: "60"
        - name: "LIMITS_ACTIONS_SEQUENCE_MAXLENGTH"
          value: "50"
        - name: "CONFIG_whisk_timeLimit_min"
          value: "100ms"
        - name: "CONFIG_whisk_timeLimit_max"
          value: "5m"
        - name: "CONFIG_whisk_timeLimit_std"
          value: "1m"
        - name: "CONFIG_whisk_memory_min"
          value: "128m"
        - name: "CONFIG_whisk_memory_max"
          value: "512m"
        - name: "CONFIG_whisk_memory_std"
          value: "256m"
        - name: "CONFIG_whisk_concurrencyLimit_min"
          value: "1"
        - name: "CONFIG_whisk_concurrencyLimit_max"
          value: "1"
        - name: "CONFIG_whisk_concurrencyLimit_std"
          value: "1"
        - name: "CONFIG_whisk_logLimit_min"
          value: "0m"
        - name: "CONFIG_whisk_logLimit_max"
          value: "10m"
        - name: "CONFIG_whisk_logLimit_std"
          value: "10m"
        - name: "CONFIG_whisk_activation_payload_max"
          value: "1048576"

        - name: "CONFIG_whisk_loadbalancer_blackboxFraction"
          value: "10%"

        - name: "CONFIG_whisk_loadbalancer_timeoutFactor"
          value: "2"

        # Kafka properties
        - name: "KAFKA_HOSTS"
          value: "openwhisk-kafka-0.openwhisk-kafka.openwhisk-second.svc.cluster.local:9092"
        - name: "CONFIG_whisk_kafka_replicationFactor"
          value: ""
        - name: "CONFIG_whisk_kafka_topics_prefix"
          value: ""
        - name: "CONFIG_whisk_kafka_topics_cacheInvalidation_retentionBytes"
          value: ""
        - name: "CONFIG_whisk_kafka_topics_cacheInvalidation_retentionMs"
          value: ""
        - name: "CONFIG_whisk_kafka_topics_cacheInvalidation_segmentBytes"
          value: ""
        - name: "CONFIG_whisk_kafka_topics_completed_retentionBytes"
          value: ""
        - name: "CONFIG_whisk_kafka_topics_completed_retentionMs"
          value: ""
        - name: "CONFIG_whisk_kafka_topics_completed_segmentBytes"
          value: ""
        - name: "CONFIG_whisk_kafka_topics_events_retentionBytes"
          value: ""
        - name: "CONFIG_whisk_kafka_topics_events_retentionMs"
          value: ""
        - name: "CONFIG_whisk_kafka_topics_events_segmentBytes"
          value: ""
        - name: "CONFIG_whisk_kafka_topics_health_retentionBytes"
          value: ""
        - name: "CONFIG_whisk_kafka_topics_health_retentionMs"
          value: ""
        - name: "CONFIG_whisk_kafka_topics_health_segmentBytes"
          value: ""
        
        - name: "CONFIG_whisk_kafka_topics_invoker_retentionBytes"
          value: ""
        - name: "CONFIG_whisk_kafka_topics_invoker_retentionMs"
          value: ""
        - name: "CONFIG_whisk_kafka_topics_invoker_segmentBytes"
          value: ""
        
        - name: "CONFIG_whisk_kafka_topics_scheduler_retentionBytes"
          value: ""
        - name: "CONFIG_whisk_kafka_topics_scheduler_retentionMs"
          value: ""
        - name: "CONFIG_whisk_kafka_topics_scheduler_segmentBytes"
          value: ""
        
        - name: "CONFIG_whisk_kafka_topics_creationAck_retentionBytes"
          value: ""
        - name: "CONFIG_whisk_kafka_topics_creationAck_retentionMs"
          value: ""
        - name: "CONFIG_whisk_kafka_topics_creationAck_segmentBytes"
          value: ""

        # etcd properties

        # properties for DB connection
        - name: "CONFIG_whisk_couchdb_username"
          valueFrom:
            secretKeyRef:
              name: openwhisk-db.auth
              key: db_username
        - name: "CONFIG_whisk_couchdb_password"
          valueFrom:
            secretKeyRef:
              name: openwhisk-db.auth
              key: db_password
        - name: "CONFIG_whisk_couchdb_port"
          valueFrom:
            configMapKeyRef:
              name: openwhisk-db.config
              key: db_port
        - name: "CONFIG_whisk_couchdb_protocol"
          valueFrom:
            configMapKeyRef:
              name: openwhisk-db.config
              key: db_protocol
        - name: "CONFIG_whisk_couchdb_host"
          value: "couchdb-gateway.liquidfaas.cloud"
        - name: "CONFIG_whisk_couchdb_provider"
          valueFrom:
            configMapKeyRef:
              name: openwhisk-db.config
              key: db_provider
        - name: "CONFIG_whisk_couchdb_databases_WhiskActivation"
          valueFrom:
            configMapKeyRef:
              name: openwhisk-db.config
              key: db_whisk_activations
        - name: "CONFIG_whisk_couchdb_databases_WhiskEntity"
          valueFrom:
            configMapKeyRef:
              name: openwhisk-db.config
              key: db_whisk_actions
        - name: "CONFIG_whisk_couchdb_databases_WhiskAuth"
          valueFrom:
            configMapKeyRef:
              name: openwhisk-db.config
              key: db_whisk_auths

        - name: "CONTROLLER_INSTANCES"
          value: "1"
        - name: "CONFIG_akka_cluster_seedNodes_0"
          value: "akka://controller-actor-system@$(POD_IP):25520"
        - name: "OPENWHISK_ENCODED_CONFIG"
          value: IwojIExpY2Vuc2VkIHRvIHRoZSBBcGFjaGUgU29mdHdhcmUgRm91bmRhdGlvbiAoQVNGKSB1bmRlciBvbmUgb3IgbW9yZQojIGNvbnRyaWJ1dG9yIGxpY2Vuc2UgYWdyZWVtZW50cy4gIFNlZSB0aGUgTk9USUNFIGZpbGUgZGlzdHJpYnV0ZWQgd2l0aAojIHRoaXMgd29yayBmb3IgYWRkaXRpb25hbCBpbmZvcm1hdGlvbiByZWdhcmRpbmcgY29weXJpZ2h0IG93bmVyc2hpcC4KIyBUaGUgQVNGIGxpY2Vuc2VzIHRoaXMgZmlsZSB0byBZb3UgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMAojICh0aGUgIkxpY2Vuc2UiKTsgeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoCiMgdGhlIExpY2Vuc2UuICBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXQKIwojICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjAKIwojIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmUKIyBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiAiQVMgSVMiIEJBU0lTLAojIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLgojIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQKIyBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KIwoKaW5jbHVkZSBjbGFzc3BhdGgoImFwcGxpY2F0aW9uLmNvbmYiKQoKd2hpc2sgewogIG1ldHJpY3MgewogICAgcHJvbWV0aGV1cy1lbmFibGVkID0gdHJ1ZQogIH0KfQo=

        - name: "METRICS_KAMON"
          value: "true"


        - name: "METRICS_KAMON_TAGS"
          value: "true"


        - name: "CONFIG_whisk_userEvents_enabled"
          value: "true"

        - name: "CONFIG_logback_log_level"
          value: "INFO"
        # properties for lean messaging provider
---
# Source: edge-chart/charts/openwhisk/templates/invoker-pod.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: openwhisk-invoker
  labels:
    name: openwhisk-invoker
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
spec:
  podManagementPolicy: "Parallel"
  serviceName: openwhisk-invoker
  replicas: 1
  selector:
    matchLabels:
      name: openwhisk-invoker
  template:
    metadata:
      labels:
        name: openwhisk-invoker
        heritage: "Helm"
        release: "openwhisk"
        chart: "openwhisk-1.0.1"
        app: openwhisk-openwhisk
      annotations:
        prometheus.io/scrape: 'true'
        prometheus.io/port:   '8080'

    spec:
      serviceAccountName: openwhisk-invoker
      restartPolicy: Always
      affinity:
        # run only on nodes labeled with openwhisk-role=invoker
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: openwhisk-role
                operator: In
                values:
                - invoker
        # Fault tolerance: prevent multiple instances of openwhisk-invoker from running on the same node
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: name
                operator: In
                values:
                - openwhisk-invoker
            topologyKey: "kubernetes.io/hostname"
      tolerations:
        - key: "openwhisk-role"
          operator: "Equal"
          value: invoker
          effect: "NoSchedule"



      initContainers:
      # Wait for a controller to be up (which implies kafka, zookeeper, couchdb, etcd are all up as well).
      - name: "wait-for-controller"
        image: "busybox:latest"
        imagePullPolicy: "IfNotPresent"
        env:
        - name: "READINESS_URL"
          value: http://openwhisk-controller.openwhisk-second.svc.cluster.local:8080/ping
        command: ["sh", "-c", "result=1; until [ $result -eq 0 ]; do echo 'Checking controller readiness'; wget -T 5 --spider $READINESS_URL; result=$?; sleep 1; done; echo 'Success: controller is ready'"]
      
      containers:
      - name: invoker
        image: "openwhisk/invoker:ef725a6"
        imagePullPolicy: "IfNotPresent"
        command: [ "/bin/bash", "-c", "/init.sh --uniqueName $INVOKER_NAME" ]
        env:
          - name: "PORT"
            value: "8080"

          # Needed by invoker to set the environment variable __OW_API_HOST in action containers
          - name: "WHISK_API_HOST_PROTO"
            valueFrom:
              configMapKeyRef:
                name: openwhisk-whisk.config
                key: whisk_internal_api_host_proto
          - name: "WHISK_API_HOST_PORT"
            valueFrom:
              configMapKeyRef:
                name: openwhisk-whisk.config
                key: whisk_internal_api_host_port
          - name: "WHISK_API_HOST_NAME"
            valueFrom:
              configMapKeyRef:
                name: openwhisk-whisk.config
                key: whisk_internal_api_host_name

          # Needed by invoker to configure the container factory & container pool
          - name: "CONFIG_whisk_docker_containerFactory_useRunc"
            value: "false"
          - name: "CONFIG_whisk_containerPool_userMemory"
            value: "2048m"
          - name: "CONFIG_whisk_containerFactory_containerArgs_network"
            value: "bridge"

          - name: "CONFIG_whisk_containerFactory_containerArgs_extraEnvVars_0"
            value: "__OW_ALLOW_CONCURRENT=false"

          - name: "CONFIG_whisk_containerFactory_runtimesRegistry_url"
            value: ""

          # Invoker name is the name of the node (DaemonSet) or pod (StatefulSet)
          - name: "INVOKER_NAME"
            valueFrom:
              fieldRef:
                fieldPath:  metadata.name 

          # Java options
          - name: "JAVA_OPTS"
            value: "-Xmx512M "

          # Invoker options
          - name: "INVOKER_OPTS"
            value: " -Dkubernetes.master=https://$KUBERNETES_SERVICE_HOST -Dwhisk.spi.ContainerFactoryProvider=org.apache.openwhisk.core.containerpool.kubernetes.KubernetesContainerFactoryProvider"

          # action runtimes
          - name: "RUNTIMES_MANIFEST"
            value: "{\n    \"runtimes\": {\n        \"nodejs\": [\n            {\n                \"kind\": \"nodejs:14\",\n                \"default\": true,\n                \"image\": {\n                    \"prefix\": \"giuliabianchi1408\",\n                    \"name\": \"action-nodejs-v14\",\n                    \"tag\": \"latest\"\n                },\n                \"deprecated\": false,\n                \"attached\": {\n                    \"attachmentName\": \"codefile\",\n                    \"attachmentType\": \"text/plain\"\n                },\n                \"stemCells\": [\n                    {\n                        \"initialCount\": 2,\n                        \"memory\": \"256 MB\",\n                        \"reactive\": {\n                            \"minCount\": 1,\n                            \"maxCount\": 4,\n                            \"ttl\": \"2 minutes\",\n                            \"threshold\": 1,\n                            \"increment\": 1\n                        }\n                    }\n                ]\n            },\n            {\n                \"kind\": \"nodejs:16\",\n                \"default\": false,\n                \"image\": {\n                    \"prefix\": \"openwhisk\",\n                    \"name\": \"action-nodejs-v16\",\n                    \"tag\": \"1.20.0\"\n                },\n                \"deprecated\": false,\n                \"attached\": {\n                    \"attachmentName\": \"codefile\",\n                    \"attachmentType\": \"text/plain\"\n                }\n            }\n        ],\n        \"python\": [\n            {\n                \"kind\": \"python:3\",\n                \"default\": true,\n                \"image\": {\n                    \"prefix\": \"openwhisk\",\n                    \"name\": \"action-python-v3.7\",\n                    \"tag\": \"1.17.0\"\n                },\n                \"deprecated\": false,\n                \"attached\": {\n                    \"attachmentName\": \"codefile\",\n                    \"attachmentType\": \"text/plain\"\n                }\n            }\n        ],\n        \"swift\": [\n            {\n                \"kind\": \"swift:4.2\",\n                \"default\": true,\n                \"image\": {\n                    \"prefix\": \"openwhisk\",\n                    \"name\": \"action-swift-v4.2\",\n                    \"tag\": \"1.17.0\"\n                },\n                \"deprecated\": false,\n                \"attached\": {\n                    \"attachmentName\": \"codefile\",\n                    \"attachmentType\": \"text/plain\"\n                }\n            },\n            {\n                \"kind\": \"swift:5.1\",\n                \"default\": false,\n                \"image\": {\n                    \"prefix\": \"openwhisk\",\n                    \"name\": \"action-swift-v5.1\",\n                    \"tag\": \"1.17.0\"\n                },\n                \"deprecated\": false,\n                \"attached\": {\n                    \"attachmentName\": \"codefile\",\n                    \"attachmentType\": \"text/plain\"\n                }\n            },\n            {\n                \"kind\": \"swift:5.3\",\n                \"default\": false,\n                \"image\": {\n                    \"prefix\": \"openwhisk\",\n                    \"name\": \"action-swift-v5.3\",\n                    \"tag\": \"1.17.0\"\n                },\n                \"deprecated\": false,\n                \"attached\": {\n                    \"attachmentName\": \"codefile\",\n                    \"attachmentType\": \"text/plain\"\n                }\n            },\n            {\n                \"kind\": \"swift:5.4\",\n                \"default\": false,\n                \"image\": {\n                    \"prefix\": \"openwhisk\",\n                    \"name\": \"action-swift-v5.4\",\n                    \"tag\": \"1.17.0\"\n                },\n                \"deprecated\": false,\n                \"attached\": {\n                    \"attachmentName\": \"codefile\",\n                    \"attachmentType\": \"text/plain\"\n                }\n            }\n        ],\n        \"java\": [\n            {\n                \"kind\": \"java:8\",\n                \"default\": true,\n                \"image\": {\n                    \"prefix\": \"openwhisk\",\n                    \"name\": \"java8action\",\n                    \"tag\": \"1.17.0\"\n                },\n                \"deprecated\": false,\n                \"attached\": {\n                    \"attachmentName\": \"jarfile\",\n                    \"attachmentType\": \"application/java-archive\"\n                },\n                \"requireMain\": true\n            }\n        ],\n        \"php\": [\n            {\n                \"kind\": \"php:7.3\",\n                \"default\": false,\n                \"deprecated\": false,\n                \"image\": {\n                    \"prefix\": \"openwhisk\",\n                    \"name\": \"action-php-v7.3\",\n                    \"tag\": \"1.17.0\"\n                },\n                \"attached\": {\n                    \"attachmentName\": \"codefile\",\n                    \"attachmentType\": \"text/plain\"\n                }\n            },\n            {\n                \"kind\": \"php:7.4\",\n                \"default\": true,\n                \"deprecated\": false,\n                \"image\": {\n                    \"prefix\": \"openwhisk\",\n                    \"name\": \"action-php-v7.4\",\n                    \"tag\": \"1.17.0\"\n                },\n                \"attached\": {\n                    \"attachmentName\": \"codefile\",\n                    \"attachmentType\": \"text/plain\"\n                }\n            },\n            {\n                \"kind\": \"php:8.0\",\n                \"default\": false,\n                \"deprecated\": false,\n                \"image\": {\n                    \"prefix\": \"openwhisk\",\n                    \"name\": \"action-php-v7.4\",\n                    \"tag\": \"1.17.0\"\n                },\n                \"attached\": {\n                    \"attachmentName\": \"codefile\",\n                    \"attachmentType\": \"text/plain\"\n                }\n            }\n        ],\n        \"ruby\": [\n            {\n                \"kind\": \"ruby:2.5\",\n                \"default\": true,\n                \"deprecated\": false,\n                \"attached\": {\n                    \"attachmentName\": \"codefile\",\n                    \"attachmentType\": \"text/plain\"\n                },\n                \"image\": {\n                    \"prefix\": \"openwhisk\",\n                    \"name\": \"action-ruby-v2.5\",\n                    \"tag\": \"1.17.0\"\n                }\n            }\n        ],\n        \"go\": [\n            {\n                \"kind\": \"go:1.17\",\n                \"default\": true,\n                \"deprecated\": false,\n                \"attached\": {\n                    \"attachmentName\": \"codefile\",\n                    \"attachmentType\": \"text/plain\"\n                },\n                \"image\": {\n                    \"prefix\": \"openwhisk\",\n                    \"name\": \"action-golang-v1.17\",\n                    \"tag\": \"1.20.0\"\n                }\n            }\n        ],\n        \"rust\": [\n            {\n                \"kind\": \"rust:1.34\",\n                \"default\": true,\n                \"deprecated\": false,\n                \"attached\": {\n                    \"attachmentName\": \"codefile\",\n                    \"attachmentType\": \"text/plain\"\n                },\n                \"image\": {\n                    \"prefix\": \"openwhisk\",\n                    \"name\": \"action-rust-v1.34\",\n                    \"tag\": \"1.3.0\"\n                }\n            }\n        ],\n        \"dotnet\": [\n            {\n                \"kind\": \"dotnet:2.2\",\n                \"default\": true,\n                \"deprecated\": false,\n                \"requireMain\": true,\n                \"image\": {\n                    \"prefix\": \"openwhisk\",\n                    \"name\": \"action-dotnet-v2.2\",\n                    \"tag\": \"1.16.0\"\n                },\n                \"attached\": {\n                    \"attachmentName\": \"codefile\",\n                    \"attachmentType\": \"text/plain\"\n                }\n            },\n            {\n                \"kind\": \"dotnet:3.1\",\n                \"default\": false,\n                \"deprecated\": false,\n                \"requireMain\": true,\n                \"image\": {\n                    \"prefix\": \"openwhisk\",\n                    \"name\": \"action-dotnet-v3.1\",\n                    \"tag\": \"1.16.0\"\n                },\n                \"attached\": {\n                    \"attachmentName\": \"codefile\",\n                    \"attachmentType\": \"text/plain\"\n                }\n            }\n        ],\n        \"ballerina\": [\n            {\n                \"kind\": \"ballerina:0.990\",\n                \"default\": true,\n                \"image\": {\n                    \"prefix\": \"openwhisk\",\n                    \"name\": \"action-ballerina-v0.990.2\",\n                    \"tag\": \"nightly\"\n                },\n                \"deprecated\": false,\n                \"attached\": {\n                    \"attachmentName\": \"codefile\",\n                    \"attachmentType\": \"text/plain\"\n                }\n            }\n        ]\n    },\n    \"blackboxes\": [\n        {\n            \"prefix\": \"openwhisk\",\n            \"name\": \"dockerskeleton\",\n            \"tag\": \"1.14.0\"\n        }\n    ]\n}\n"

          # Action limits
          - name: "LIMITS_ACTIONS_INVOKES_PERMINUTE"
            value: "60"
          - name: "LIMITS_ACTIONS_INVOKES_CONCURRENT"
            value: "30"
          - name: "LIMITS_TRIGGERS_FIRES_PERMINUTE"
            value: "60"
          - name: "LIMITS_ACTIONS_SEQUENCE_MAXLENGTH"
            value: "50"
          - name: "CONFIG_whisk_timeLimit_min"
            value: "100ms"
          - name: "CONFIG_whisk_timeLimit_max"
            value: "5m"
          - name: "CONFIG_whisk_timeLimit_std"
            value: "1m"
          - name: "CONFIG_whisk_memory_min"
            value: "128m"
          - name: "CONFIG_whisk_memory_max"
            value: "512m"
          - name: "CONFIG_whisk_memory_std"
            value: "256m"
          - name: "CONFIG_whisk_concurrencyLimit_min"
            value: "1"
          - name: "CONFIG_whisk_concurrencyLimit_max"
            value: "1"
          - name: "CONFIG_whisk_concurrencyLimit_std"
            value: "1"
          - name: "CONFIG_whisk_logLimit_min"
            value: "0m"
          - name: "CONFIG_whisk_logLimit_max"
            value: "10m"
          - name: "CONFIG_whisk_logLimit_std"
            value: "10m"
          - name: "CONFIG_whisk_activation_payload_max"
            value: "1048576"

          # Default to empty logs dir. This is because logs should go to stdout
          - name: "WHISK_LOGS_DIR"
            value: ""

          # this version is the day it is deployed,
          - name:  "CONFIG_whisk_info_date"
            valueFrom:
              configMapKeyRef:
                name: openwhisk-whisk.config
                key: whisk_info_date

          # properties for DB connection
          - name: "CONFIG_whisk_couchdb_username"
            valueFrom:
              secretKeyRef:
                name: openwhisk-db.auth
                key: db_username
          - name: "CONFIG_whisk_couchdb_password"
            valueFrom:
              secretKeyRef:
                name: openwhisk-db.auth
                key: db_password
          - name: "CONFIG_whisk_couchdb_port"
            valueFrom:
              configMapKeyRef:
                name: openwhisk-db.config
                key: db_port
          - name: "CONFIG_whisk_couchdb_protocol"
            valueFrom:
              configMapKeyRef:
                name: openwhisk-db.config
                key: db_protocol
          - name: "CONFIG_whisk_couchdb_host"
            value: "couchdb-gateway.liquidfaas.cloud"
          - name: "CONFIG_whisk_couchdb_provider"
            valueFrom:
              configMapKeyRef:
                name: openwhisk-db.config
                key: db_provider
          - name: "CONFIG_whisk_couchdb_databases_WhiskActivation"
            valueFrom:
              configMapKeyRef:
                name: openwhisk-db.config
                key: db_whisk_activations
          - name: "CONFIG_whisk_couchdb_databases_WhiskEntity"
            valueFrom:
              configMapKeyRef:
                name: openwhisk-db.config
                key: db_whisk_actions
          - name: "CONFIG_whisk_couchdb_databases_WhiskAuth"
            valueFrom:
              configMapKeyRef:
                name: openwhisk-db.config
                key: db_whisk_auths

          # properties for kafka connection
          - name: "KAFKA_HOSTS"
            value: "openwhisk-kafka-0.openwhisk-kafka.openwhisk-second.svc.cluster.local:9092"
          - name: "CONFIG_whisk_kafka_replicationFactor"
            value: ""
          - name: "CONFIG_whisk_kafka_topics_prefix"
            value: ""
          - name: "CONFIG_whisk_kafka_topics_cacheInvalidation_retentionBytes"
            value: ""
          - name: "CONFIG_whisk_kafka_topics_cacheInvalidation_retentionMs"
            value: ""
          - name: "CONFIG_whisk_kafka_topics_cacheInvalidation_segmentBytes"
            value: ""
          - name: "CONFIG_whisk_kafka_topics_completed_retentionBytes"
            value: ""
          - name: "CONFIG_whisk_kafka_topics_completed_retentionMs"
            value: ""
          - name: "CONFIG_whisk_kafka_topics_completed_segmentBytes"
            value: ""
          - name: "CONFIG_whisk_kafka_topics_events_retentionBytes"
            value: ""
          - name: "CONFIG_whisk_kafka_topics_events_retentionMs"
            value: ""
          - name: "CONFIG_whisk_kafka_topics_events_segmentBytes"
            value: ""
          - name: "CONFIG_whisk_kafka_topics_health_retentionBytes"
            value: ""
          - name: "CONFIG_whisk_kafka_topics_health_retentionMs"
            value: ""
          - name: "CONFIG_whisk_kafka_topics_health_segmentBytes"
            value: ""
          
          - name: "CONFIG_whisk_kafka_topics_invoker_retentionBytes"
            value: ""
          - name: "CONFIG_whisk_kafka_topics_invoker_retentionMs"
            value: ""
          - name: "CONFIG_whisk_kafka_topics_invoker_segmentBytes"
            value: ""
          
          - name: "CONFIG_whisk_kafka_topics_scheduler_retentionBytes"
            value: ""
          - name: "CONFIG_whisk_kafka_topics_scheduler_retentionMs"
            value: ""
          - name: "CONFIG_whisk_kafka_topics_scheduler_segmentBytes"
            value: ""
          
          - name: "CONFIG_whisk_kafka_topics_creationAck_retentionBytes"
            value: ""
          - name: "CONFIG_whisk_kafka_topics_creationAck_retentionMs"
            value: ""
          - name: "CONFIG_whisk_kafka_topics_creationAck_segmentBytes"
            value: ""

          # etcd properties

          # properties for zookeeper connection
          - name: "ZOOKEEPER_HOSTS"
            value: "openwhisk-zookeeper-0.openwhisk-zookeeper.openwhisk-second.svc.cluster.local:2181"

          - name: "OPENWHISK_ENCODED_CONFIG"
            value: IwojIExpY2Vuc2VkIHRvIHRoZSBBcGFjaGUgU29mdHdhcmUgRm91bmRhdGlvbiAoQVNGKSB1bmRlciBvbmUgb3IgbW9yZQojIGNvbnRyaWJ1dG9yIGxpY2Vuc2UgYWdyZWVtZW50cy4gIFNlZSB0aGUgTk9USUNFIGZpbGUgZGlzdHJpYnV0ZWQgd2l0aAojIHRoaXMgd29yayBmb3IgYWRkaXRpb25hbCBpbmZvcm1hdGlvbiByZWdhcmRpbmcgY29weXJpZ2h0IG93bmVyc2hpcC4KIyBUaGUgQVNGIGxpY2Vuc2VzIHRoaXMgZmlsZSB0byBZb3UgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMAojICh0aGUgIkxpY2Vuc2UiKTsgeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoCiMgdGhlIExpY2Vuc2UuICBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXQKIwojICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjAKIwojIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmUKIyBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiAiQVMgSVMiIEJBU0lTLAojIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLgojIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQKIyBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KIwoKaW5jbHVkZSBjbGFzc3BhdGgoImFwcGxpY2F0aW9uLmNvbmYiKQoKd2hpc2sgewogIG1ldHJpY3MgewogICAgcHJvbWV0aGV1cy1lbmFibGVkID0gdHJ1ZQogIH0KfQo=


          - name: "METRICS_KAMON"
            value: "true"


          - name: "METRICS_KAMON_TAGS"
            value: "true"


          - name: "CONFIG_whisk_userEvents_enabled"
            value: "true"

          - name: "CONFIG_logback_log_level"
            value: "INFO"
          - name: "CONFIG_whisk_helm_release"
            value: "openwhisk"
          - name: "CONFIG_akka_coordinatedShutdown_phases_actorSystemTerminate_timeout"
            value: "30 s"
          - name: "CONFIG_whisk_runtime_delete_timeout"
            value: "30 seconds"
        ports:
        - name: invoker
          containerPort: 8080
---
# Source: edge-chart/charts/openwhisk/templates/kafka-pod.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: openwhisk-kafka
  labels:
    name: openwhisk-kafka
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
spec:
  serviceName: openwhisk-kafka
  podManagementPolicy: "Parallel"
  replicas: 1
  selector:
    matchLabels:
      name: openwhisk-kafka
  template:
    metadata:
      labels:
        name: openwhisk-kafka
        heritage: "Helm"
        release: "openwhisk"
        chart: "openwhisk-1.0.1"
        app: openwhisk-openwhisk
    spec:
      restartPolicy: Always
      affinity:
        # prefer to not run on an invoker node (only prefer because of single node clusters)
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            preference:
              matchExpressions:
              - key: openwhisk-role
                operator: NotIn
                values:
                - invoker
          - weight: 80
            preference:
              matchExpressions:
              - key: openwhisk-role
                operator: In
                values:
                - core
        # Fault tolerance: prevent multiple instances of openwhisk-kafka from running on the same node
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: name
                operator: In
                values:
                - openwhisk-kafka
            topologyKey: "kubernetes.io/hostname"
      tolerations:
        - key: "openwhisk-role"
          operator: "Equal"
          value: core
          effect: "NoSchedule"
      volumes:
      - name: "openwhisk-kafka-pvc"
        persistentVolumeClaim:
          claimName: "openwhisk-kafka-pvc"

      initContainers:
      - name: "wait-for-zookeeper"
        image: "busybox:latest"
        imagePullPolicy: "IfNotPresent"
        command: ["sh", "-c", 'result=1; until [ $result -eq 0 ]; do OK=$(echo ruok | nc -w 1 
      openwhisk-zookeeper-0.openwhisk-zookeeper.openwhisk-second.svc.cluster.local 2181); if [ "$OK" == "imok" ]; then result=0; echo "zookeeper returned imok!"; else echo waiting for zookeeper to be ready; sleep 1; fi; done; echo "Success: zookeeper is up"']
      
      containers:
      - name: kafka
        image: "wurstmeister/kafka:2.12-2.3.1"
        imagePullPolicy: "IfNotPresent"
        command: ["/bin/bash", "-c", "export KAFKA_BROKER_ID=`hostname | awk -F '-' '{print $NF}'`; /usr/bin/start-kafka.sh"]
        volumeMounts:
        - mountPath: /kafka
          name: "openwhisk-kafka-pvc"
        ports:
        - containerPort: 9092
          name: kafka

        livenessProbe:
          tcpSocket:
            port: 9092
          initialDelaySeconds: 100
          periodSeconds: 10
          timeoutSeconds: 1000
        readinessProbe:
          initialDelaySeconds: 100
          periodSeconds: 10
          timeoutSeconds: 1000
          exec:
            command:
            - /opt/kafka/bin/kafka-topics.sh
            - localhost:9092
            - --version
        env:
        - name: "HOSTNAME_COMMAND"
          value: "hostname -f"
        - name: "KAFKA_ADVERTISED_PORT"
          value: "9092"
        - name: "KAFKA_PORT"
          value: "9092"
        - name: "KAFKA_LISTENER_SECURITY_PROTOCOL_MAP"
          value: "EXTERNAL:PLAINTEXT"
        - name: "KAFKA_LISTENERS"
          value: "EXTERNAL://:9092"
        - name: "KAFKA_ADVERTISED_LISTENERS"
          value: "EXTERNAL://_{HOSTNAME_COMMAND}:9092"
        - name: "KAFKA_INTER_BROKER_LISTENER_NAME"
          value: "EXTERNAL"

        # zookeeper info
        - name: "KAFKA_ZOOKEEPER_CONNECT"
          value: "openwhisk-zookeeper-0.openwhisk-zookeeper.openwhisk-second.svc.cluster.local:2181"
---
# Source: edge-chart/charts/openwhisk/templates/prometheus-pod.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#


apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: openwhisk-prometheus-server
  labels:
    name: openwhisk-prometheus-server
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
spec:
  serviceName: openwhisk-prometheus-server
  replicas: 1
  selector:
    matchLabels:
      name: openwhisk-prometheus-server
  template:
    metadata:
      labels:
        name: openwhisk-prometheus-server
        heritage: "Helm"
        release: "openwhisk"
        chart: "openwhisk-1.0.1"
        app: openwhisk-openwhisk
    spec:
      restartPolicy: Always
      affinity:
        # prefer to not run on an invoker node (only prefer because of single node clusters)
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            preference:
              matchExpressions:
              - key: openwhisk-role
                operator: NotIn
                values:
                - invoker
          - weight: 80
            preference:
              matchExpressions:
              - key: openwhisk-role
                operator: In
                values:
                - core
        # Fault tolerance: prevent multiple instances of openwhisk-prometheus-server from running on the same node
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: name
                operator: In
                values:
                - openwhisk-prometheus-server
            topologyKey: "kubernetes.io/hostname"
      tolerations:
        - key: "openwhisk-role"
          operator: "Equal"
          value: core
          effect: "NoSchedule"

      securityContext:
        fsGroup: 2000
        runAsUser: 1000
        runAsNonRoot: true
      serviceAccountName: openwhisk-prometheus-server
      containers:
        - name: prometheus
          imagePullPolicy: "IfNotPresent"
          image: "prom/prometheus:v2.14.0"
          args:
            - "--config.file=/etc/prometheus/prometheus.yaml"
            - "--storage.tsdb.path=/prometheus/"
          ports:
            - containerPort: 9090
          livenessProbe:
            httpGet:
              path: /-/healthy
              port: 9090
            initialDelaySeconds: 30
            timeoutSeconds: 5
          readinessProbe:
            httpGet:
              path: /-/healthy
              port: 9090

          volumeMounts:
            - name: prometheus-config-volume
              mountPath: /etc/prometheus/
            - name: prometheus-storage-volume
              mountPath: /prometheus/

      volumes:
      - name: prometheus-config-volume
        configMap:
          name: "openwhisk-prometheus-configuration"
      - name: prometheus-storage-volume
        persistentVolumeClaim:
          claimName: "openwhisk-prometheus-pvc"
---
# Source: edge-chart/charts/openwhisk/templates/zookeeper-pod.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: openwhisk-zookeeper
  labels:
    name: openwhisk-zookeeper
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
spec:
  serviceName: openwhisk-zookeeper
  podManagementPolicy: "Parallel"
  replicas: 1
  selector:
    matchLabels:
      name: openwhisk-zookeeper
  template:
    metadata:
      labels:
        name: openwhisk-zookeeper
        heritage: "Helm"
        release: "openwhisk"
        chart: "openwhisk-1.0.1"
        app: openwhisk-openwhisk
    spec:
      restartPolicy: "Always"
      affinity:
        # prefer to not run on an invoker node (only prefer because of single node clusters)
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            preference:
              matchExpressions:
              - key: openwhisk-role
                operator: NotIn
                values:
                - invoker
          - weight: 80
            preference:
              matchExpressions:
              - key: openwhisk-role
                operator: In
                values:
                - core
        # Fault tolerance: prevent multiple instances of openwhisk-zookeeper from running on the same node
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: name
                operator: In
                values:
                - openwhisk-zookeeper
            topologyKey: "kubernetes.io/hostname"
      tolerations:
        - key: "openwhisk-role"
          operator: "Equal"
          value: core
          effect: "NoSchedule"

      volumes:
        - name: zk-config
          configMap:
            name: openwhisk-zookeeper
        - name: "openwhisk-zookeeper-pvc-data"
          persistentVolumeClaim:
            claimName: "openwhisk-zookeeper-pvc-data"
        - name: "openwhisk-zookeeper-pvc-datalog"
          persistentVolumeClaim:
            claimName: "openwhisk-zookeeper-pvc-datalog"
      
      containers:
      - name: zookeeper
        image: "zookeeper:3.4"
        imagePullPolicy: "IfNotPresent"
        command: ["/bin/bash", "-c", "hostname -s | awk -F '-' '{print $NF}'> /data/myid; cat /data/myid; cat /conf/zoo.cfg; zkServer.sh start-foreground"]
        ports:
        - name: zookeeper
          containerPort: 2181
        - name: server
          containerPort: 2888
        - name: leader-election
          containerPort: 3888

        livenessProbe:
          tcpSocket:
            port: 2181
          initialDelaySeconds: 100
          periodSeconds: 10
          timeoutSeconds: 1000
        readinessProbe:
          exec:
            command:
            - /bin/bash
            - -c
            - "echo ruok | nc -w 1 localhost 2181 | grep imok"
          initialDelaySeconds: 100
          periodSeconds: 10
          timeoutSeconds: 1000
        volumeMounts:
        - mountPath: /conf
          name: zk-config
        - mountPath: /data
          name: "openwhisk-zookeeper-pvc-data"
        - mountPath: /datalog
          name: "openwhisk-zookeeper-pvc-datalog"
---
# Source: edge-chart/charts/openwhisk/templates/gen-certs-job.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
apiVersion: batch/v1
kind: Job
metadata:
  name: openwhisk-gen-certs
  labels:
    name: openwhisk-gen-certs
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
spec:
  backoffLimit: 3
  template:
    metadata:
      name: openwhisk-gen-certs
      labels:
        name: openwhisk-gen-certs
        heritage: "Helm"
        release: "openwhisk"
        chart: "openwhisk-1.0.1"
        app: openwhisk-openwhisk
    spec:
      serviceAccountName: openwhisk-init-sa
      restartPolicy: Never
      volumes:
      - name: task-dir
        configMap:
          name: openwhisk-gen-certs
      
      containers:
      - name: gen-certs
        image: "openwhisk/ow-utils:ef725a6"
        imagePullPolicy: "IfNotPresent"
        command: ["/bin/bash", "-c", "set -e; . /task/gencerts.sh"]
        volumeMounts:
        - name: task-dir
          mountPath: "/task/gencerts.sh"
          subPath: "gencerts.sh"
        env:
        - name: "NGINX_CERT_SECRET"
          value: openwhisk-nginx
        - name: "WHISK_API_HOST_NAME"
          valueFrom:
            configMapKeyRef:
              name: openwhisk-whisk.config
              key: whisk_external_api_host_name
---
# Source: edge-chart/charts/openwhisk/templates/install-packages-job.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

apiVersion: batch/v1
kind: Job
metadata:
  name: openwhisk-install-packages
  labels:
    name: openwhisk-install-packages
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
spec:
  backoffLimit: 3
  template:
    metadata:
      name: openwhisk-install-packages
      labels:
        name: openwhisk-install-packages
        heritage: "Helm"
        release: "openwhisk"
        chart: "openwhisk-1.0.1"
        app: openwhisk-openwhisk
    spec:
      restartPolicy: Never
      volumes:
      - name: task-dir
        configMap:
          name: openwhisk-install-packages-cm
      initContainers:
      - name: "wait-for-healthy-invoker"
        image: "busybox:latest"
        imagePullPolicy: "IfNotPresent"
        env:
        - name: "READINESS_URL"
          value: "http://openwhisk-controller.openwhisk-second.svc.cluster.local:8080/invokers/healthy/count"
        command: ["sh", "-c", "echo 0 > /tmp/count.txt; while true; do echo 'waiting for healthy invoker'; wget -T 5 -qO /tmp/count.txt --no-check-certificate \"$READINESS_URL\"; NUM_HEALTHY_INVOKERS=$(cat /tmp/count.txt); if [ $NUM_HEALTHY_INVOKERS -gt 0 ]; then echo \"Success: there are $NUM_HEALTHY_INVOKERS healthy invokers\"; break; fi; echo '...not ready yet; sleeping 3 seconds before retry'; sleep 3; done;"]

      
      containers:
      - name: install-packages
        image: "openwhisk/ow-utils:ef725a6"
        imagePullPolicy: "IfNotPresent"
        command: ["/bin/bash", "-c", "set -e; . /task/myTask.sh"]
        volumeMounts:
        - name: task-dir
          mountPath: "/task/myTask.sh"
          subPath: "myTask.sh"
        env:
          - name: "WHISK_AUTH"
            valueFrom:
              secretKeyRef:
                name: openwhisk-whisk.auth
                key: system
          - name: "WHISK_API_HOST"
            valueFrom:
              configMapKeyRef:
                name: openwhisk-whisk.config
                key: whisk_internal_api_host_nameAndPort
          - name: "WHISK_API_HOST_URL"
            valueFrom:
              configMapKeyRef:
                name: openwhisk-whisk.config
                key: whisk_internal_api_host_url
          # apigateway configuration (for installing routemgmt actions)
          - name: "WHISK_SYSTEM_NAMESPACE"
            valueFrom:
              configMapKeyRef:
                name: openwhisk-whisk.config
                key: whisk_system_namespace
          - name: "WHISK_API_GATEWAY_HOST_V2"
            value: "http://openwhisk-apigateway.openwhisk-second.svc.cluster.local:9000/v2"

          # Provider database configuration
          # Use the internally deployed CouchDB service for the providers
          - name: "PROVIDER_DB_HOST"
            valueFrom:
              configMapKeyRef:
                name: openwhisk-db.config
                key: db_host
          - name: "PROVIDER_DB_PROTOCOL"
            valueFrom:
              configMapKeyRef:
                name: openwhisk-db.config
                key: db_protocol
          - name: "PROVIDER_DB_PORT"
            valueFrom:
              configMapKeyRef:
                name: openwhisk-db.config
                key: db_port
          - name: "PROVIDER_DB_USERNAME"
            valueFrom:
              secretKeyRef:
                name: openwhisk-db.auth
                key: db_username
          - name: "PROVIDER_DB_PASSWORD"
            valueFrom:
              secretKeyRef:
                name: openwhisk-db.auth
                key: db_password
          

          # Provider database table prefixes
          - name: "ALARM_DB_PREFIX"
            value: "alm"
          - name: "KAFKA_DB_PREFIX"
            value: "kp"

          # Should each of the providers be installed?
          - name: "OW_INSTALL_ALARM_PROVIDER"
            value:  "yes" 
          - name: "OW_INSTALL_KAFKA_PROVIDER"
            value:  "no" 

          # tags to use for git clone operations
          - name: "OW_GIT_TAG_OPENWHISK"
            value: "ef725a653ab112391f79c274d8e3dcfb915d59a3"
          - name: "OW_GIT_TAG_OPENWHISK_CATALOG"
            value: "1.0.0"
          - name: "OW_GIT_TAG_OPENWHISK_PACKAGE_ALARMS"
            value: "2.3.0"
          - name: "OW_GIT_TAG_OPENWHISK_PACKAGE_KAFKA"
            value: "2.1.0"
---
# Source: edge-chart/charts/openwhisk/templates/controller-pdb.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
---
# Source: edge-chart/charts/openwhisk/templates/couchdb-init-cm.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
---
# Source: edge-chart/charts/openwhisk/templates/couchdb-init-job.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
---
# Source: edge-chart/charts/openwhisk/templates/couchdb-pod.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
---
# Source: edge-chart/charts/openwhisk/templates/couchdb-pvc.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
---
# Source: edge-chart/charts/openwhisk/templates/couchdb-svc.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
---
# Source: edge-chart/charts/openwhisk/templates/elasticsearch-cm.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
---
# Source: edge-chart/charts/openwhisk/templates/elasticsearch-pdb.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
---
# Source: edge-chart/charts/openwhisk/templates/elasticsearch-pod.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
---
# Source: edge-chart/charts/openwhisk/templates/elasticsearch-psp.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
---
# Source: edge-chart/charts/openwhisk/templates/elasticsearch-role.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
---
# Source: edge-chart/charts/openwhisk/templates/elasticsearch-rolebind.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
---
# Source: edge-chart/charts/openwhisk/templates/elasticsearch-svc.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
---
# Source: edge-chart/charts/openwhisk/templates/elasticsearch-svcacct.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
---
# Source: edge-chart/charts/openwhisk/templates/etcd-pod.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
---
# Source: edge-chart/charts/openwhisk/templates/frontdoor-ingress.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
---
# Source: edge-chart/charts/openwhisk/templates/frontdoor-secrets.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
---
# Source: edge-chart/charts/openwhisk/templates/invoker-pdb.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
---
# Source: edge-chart/charts/openwhisk/templates/invoker-pod.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
---
# Source: edge-chart/charts/openwhisk/templates/invoker-svcacct.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

# When using KubernetesContainerFactory, invoker pods need extensive
# permissions to manage pods and deployments. The ability to create
# pods can enable privilege escalation attacks, so restrict it to a
# ServiceAccount that is only used for the invokers and only defined
# when using KubernetesContainerFactory.
---
# Source: edge-chart/charts/openwhisk/templates/kafka-pdb.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
---
# Source: edge-chart/charts/openwhisk/templates/kafka-pod.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
---
# Source: edge-chart/charts/openwhisk/templates/kafka-svc.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
---
# Source: edge-chart/charts/openwhisk/templates/ow-docker-registry-secret.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
---
# Source: edge-chart/charts/openwhisk/templates/private-registry-secret.yml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
---
# Source: edge-chart/charts/openwhisk/templates/provider-kafka-pod.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
---
# Source: edge-chart/charts/openwhisk/templates/scheduler-pdb.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
---
# Source: edge-chart/charts/openwhisk/templates/scheduler-pod.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
---
# Source: edge-chart/charts/openwhisk/templates/scheduler-svc.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
---
# Source: edge-chart/charts/openwhisk/templates/tests/systemtest-cm.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
---
# Source: edge-chart/charts/openwhisk/templates/tests/systemtest-pod.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
---
# Source: edge-chart/charts/openwhisk/templates/zookeeper-cm.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
---
# Source: edge-chart/charts/openwhisk/templates/zookeeper-pdb.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
---
# Source: edge-chart/charts/openwhisk/templates/zookeeper-pod.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
---
# Source: edge-chart/charts/openwhisk/templates/zookeeper-svc.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
---
# Source: edge-chart/charts/openwhisk/templates/tests/package-checker-pod.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
apiVersion: v1
kind: Pod
metadata:
  name: openwhisk-tests-package-checker
  labels:
    name: openwhisk-tests-package-checker
    ow-testpod: "true"
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
  annotations:
    "helm.sh/hook": test-success
spec:
  restartPolicy: Never
  volumes:
  - name: task-dir
    configMap:
      name: openwhisk-tests-package-checker
  
  containers:
  - name: package-checker
    image: "openwhisk/ow-utils:ef725a6"
    imagePullPolicy: "IfNotPresent"
    command: ["/bin/bash", "/task/myTask.sh"]
    volumeMounts:
    - name: task-dir
      mountPath: "/task/myTask.sh"
      subPath: "myTask.sh"
    env:
      - name: "WSK_AUTH"
        valueFrom:
          secretKeyRef:
            name: openwhisk-whisk.auth
            key: guest
      - name: "WSK_API_HOST_URL"
        valueFrom:
          configMapKeyRef:
            name: openwhisk-whisk.config
            key: whisk_internal_api_host_url

      # Which of the providers was installed (and thus should be checked)?
      - name: "OW_INSTALL_ALARM_PROVIDER"
        value:  "yes" 
      - name: "OW_INSTALL_KAFKA_PROVIDER"
        value:  "no"
---
# Source: edge-chart/charts/openwhisk/templates/tests/smoketest-pod.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
apiVersion: v1
kind: Pod
metadata:
  name: openwhisk-tests-smoketest
  labels:
    name: openwhisk-tests-smoketest
    ow-testpod: "true"
    heritage: "Helm"
    release: "openwhisk"
    chart: "openwhisk-1.0.1"
    app: openwhisk-openwhisk
  annotations:
    "helm.sh/hook": test-success
spec:
  restartPolicy: Never
  volumes:
  - name: task-dir
    configMap:
      name: openwhisk-tests-smoketest
  
  containers:
  - name: smoketest
    image: "openwhisk/ow-utils:ef725a6"
    imagePullPolicy: "IfNotPresent"
    command: ["/bin/bash", "/task/myTask.sh"]
    volumeMounts:
    - name: task-dir
      mountPath: "/task/myTask.sh"
      subPath: "myTask.sh"
    env:
      - name: "WSK_AUTH"
        valueFrom:
          secretKeyRef:
            name: openwhisk-whisk.auth
            key: guest
      - name: "WSK_API_HOST_URL"
        valueFrom:
          configMapKeyRef:
            name: openwhisk-whisk.config
            key: whisk_internal_api_host_url
